<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oh My Games - Jeux</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div id="group-info" style="text-align: right; margin-top: 10px; margin-right: 10px;">
    <span id="current-group-alias"></span>
    <button onclick="location.href='groupes.html'" class="btn-home" style="position: static; margin-left: 10px; padding: 5px 10px;">Changer de groupe</button>
  </div>
  <h1>Oh My Games</h1>
  <h2>Liste des jeux</h2>
  <img src="omg_img.png" alt="Fond" class="background-image" />

  <button class="btn-add">‚ûï Ajouter un jeu</button>

  <div id="alpha-filter-container">
    </div>

  <input type="text" id="recherche-jeux" placeholder="üîç Rechercher un jeu..." />

  <div id="liste-jeux">
    </div>

  <button class="btn-home" onclick="location.href='home.html'">üè† Home</button>

  <div id="modal-ajout" class="modal">
    <div id="modal-content" class="modal-content">
      <button id="btn-fermer" class="close-button">&times;</button>
      <h3>Ajouter/Modifier un jeu</h3>
      <form id="form-ajout">
        <input type="hidden" id="jeu-id">
        <label for="nom-jeu">Nom du jeu :</label>
        <input type="text" id="nom-jeu" name="nom-jeu" required><br><br>

        <label for="proprietaire-jeu">Propri√©taire :</label>
        <select id="proprietaire-jeu" name="proprietaire-jeu">
          <option value="">S√©lectionner un propri√©taire</option>
          <option value="ajouter-proprietaire">‚ûï Ajouter un propri√©taire</option>
        </select><br><br>

        <label for="photos-jeu">Photos du jeu (optionnel) :</label>
        <input type="file" id="photos-jeu" name="photos-jeu" accept="image/*" multiple><br><br>

        <div id="photos-preview-container" style="display: none; margin-bottom: 10px;">
            <p>Photos actuelles :</p>
            <div id="photos-preview" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
        </div>

        <label for="min-joueurs">Min. Joueurs :</label>
        <input type="number" id="min-joueurs" name="min-joueurs" min="1" value="1"><br><br>

        <label for="max-joueurs">Max. Joueurs :</label>
        <input type="number" id="max-joueurs" name="max-joueurs" min="1" value="4"><br><br>

        <input type="checkbox" id="prete" name="prete">
        <label for="prete">Pr√™t√© √† quelqu'un</label><br>
        <input type="text" id="prete-a" name="prete-a" placeholder="Nom de la personne" style="display: none;"><br><br>

        <input type="checkbox" id="emprunte" name="emprunte">
        <label for="emprunte">Emprunt√© (ne nous appartient pas)</label><br>
        <input type="text" id="emprunte-a" name="emprunte-a" placeholder="Nom de la personne" style="display: none;"><br><br>

        <button type="submit">Ajouter le jeu</button>
      </form>
    </div>
  </div>

  <script type="module">
    console.log("Script jeux.html charg√©.");

    // CORRECTION 404: Utilisation du chemin absolu
    import { supabase } from '/supabase-config.js';

    let jeux = [];
    let joueurs = []; 
    let partiesStats = new Map();
    let proprietaires = [];
    const photosBucket = 'jeu-photos';
    
    let joueurIdToNom = new Map();

    // DOM References
    const modal = document.getElementById('modal-ajout');
    const btnAdd = document.querySelector('.btn-add');
    const btnFermer = document.getElementById('btn-fermer');
    const formAjout = document.getElementById('form-ajout');
    const listeJeux = document.getElementById('liste-jeux');
    const inputRecherche = document.getElementById('recherche-jeux');
    const alphaFilterContainer = document.getElementById('alpha-filter-container');

    const jeuIdInput = document.getElementById('jeu-id');
    const nomJeuInput = document.getElementById('nom-jeu');
    const proprietaireJeuSelect = document.getElementById('proprietaire-jeu');
    const photosJeuInput = document.getElementById('photos-jeu');
    const minJoueursInput = document.getElementById('min-joueurs');
    const maxJoueursInput = document.getElementById('max-joueurs');
    const preteCheckbox = document.getElementById('prete');
    const preteAInput = document.getElementById('prete-a');
    const emprunteCheckbox = document.getElementById('emprunte');
    const emprunteAInput = document.getElementById('emprunte-a');
    const photosPreviewContainer = document.getElementById('photos-preview-container');
    const photosPreviewDiv = document.getElementById('photos-preview');
    const btnSubmit = formAjout.querySelector('button[type="submit"]');

    let currentAlphaFilter = '';
    let selectedGroupId = null;
    let oldPhotosUrls = []; // Pour stocker les URLs des photos existantes lors de la modification

    // --- V√©rification de l'authentification et du groupe (CRITIQUE) ---
    async function checkAuthAndGroup() {
        const { data: { session } } = await supabase.auth.getSession();
        
        selectedGroupId = localStorage.getItem('selected_group_id');

        if (!session || !selectedGroupId) {
            location.href = 'groupes.html'; 
            return false;
        }
        
        const selectedGroupAlias = localStorage.getItem('selected_group_alias');
        document.getElementById('current-group-alias').textContent = `Groupe : ${selectedGroupAlias}`;
        
        return true;
    }

    // --- Fonctions de gestion des joueurs (N√âCESSAIRE pour la conversion ID->Nom) ---
    async function chargerJoueurs() {
        try {
            const { data, error } = await supabase
                .from('joueurs')
                .select('id, nom')
                .eq('groupe_id', selectedGroupId); 
            if (error) throw error;
            return data;
        } catch (error) {
            console.error("Erreur lors du chargement des joueurs:", error);
            return [];
        }
    }


    // --- Fonctions de gestion des propri√©taires ---
    async function chargerProprietaires() {
        try {
            const { data, error } = await supabase
                .from('proprietaires')
                .select('*')
                .eq('groupe_id', selectedGroupId)
                .order('nom', { ascending: true });
            if (error) throw error;
            proprietaires = data;
            mettreAJourSelectProprietaires();
        } catch (error) {
            console.error("Erreur lors du chargement des propri√©taires:", error);
        }
    }

    function mettreAJourSelectProprietaires() {
        const options = Array.from(proprietaireJeuSelect.options).filter(opt => opt.value === "" || opt.value === "ajouter-proprietaire");
        proprietaireJeuSelect.innerHTML = '';
        options.forEach(opt => proprietaireJeuSelect.appendChild(opt));

        proprietaires.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.nom;
            proprietaireJeuSelect.insertBefore(option, proprietaireJeuSelect.options[proprietaireJeuSelect.options.length - 1]);
        });
    }

    async function ajouterNouveauProprietaire() {
        const nom = prompt("Entrez le nom du nouveau propri√©taire :");
        if (nom && nom.trim() !== '') {
            try {
                const { data, error } = await supabase.from('proprietaires')
                    .insert({ nom: nom.trim(), groupe_id: selectedGroupId })
                    .select();
                if (error) {
                    if (error.code === '23505') {
                        alert("Ce propri√©taire existe d√©j√†.");
                    } else {
                        throw error;
                    }
                } else {
                    proprietaires.push(data[0]);
                    proprietaires.sort((a, b) => a.nom.localeCompare(b.nom));
                    mettreAJourSelectProprietaires();
                    proprietaireJeuSelect.value = data[0].id;
                }
            } catch (error) {
                console.error("Erreur lors de l'ajout du propri√©taire:", error);
                alert("Erreur lors de l'ajout du propri√©taire: " + error.message);
            }
        }
    }

    // --- Fonctions de gestion des photos avec Supabase Storage ---
    async function uploaderPhotos(photosFiles) {
        const photosUrls = [];
        for (const file of photosFiles) {
            const fileExt = file.name.split('.').pop();
            // Utiliser Date.now() pour garantir l'unicit√©
            const fileName = `${selectedGroupId}/${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`; 
            const { data, error } = await supabase.storage.from(photosBucket).upload(fileName, file);

            if (error) {
                console.error("Erreur lors de l'upload de l'image:", error);
                alert(`Erreur lors de l'upload de l'image: ${error.message}`);
                continue;
            }

            const { data: urlData, error: publicUrlError } = supabase.storage.from(photosBucket).getPublicUrl(data.path);
            if (publicUrlError) {
                console.error("Erreur lors de la r√©cup√©ration de l'URL publique:", publicUrlError);
                alert(`Erreur lors de la r√©cup√©ration de l'URL publique: ${publicUrlError.message}`);
                continue;
            }

            photosUrls.push(urlData.publicUrl);
        }
        return photosUrls;
    }

    async function supprimerPhotos(photosUrls) {
        if (!photosUrls || !Array.isArray(photosUrls) || photosUrls.length === 0) {
            return;
        }
        
        const filePaths = photosUrls.map(url => {
            // Extrait le chemin 'groupeId/nomDuFichier.ext' du publicUrl
            const urlPath = new URL(url).pathname;
            const bucketName = `/${photosBucket}/`;
            const pathStart = urlPath.indexOf(bucketName);
            if (pathStart === -1) return null;
            return urlPath.substring(pathStart + bucketName.length);
        }).filter(path => path !== null);

        if (filePaths.length === 0) return;

        const { error } = await supabase.storage.from(photosBucket).remove(filePaths);
        if (error) {
            console.error("Erreur lors de la suppression des images du storage:", error);
        }
    }

    // --- Fonction de chargement des statistiques de parties (CORRIG√âE) ---
    async function chargerStatistiquesParties() {
        if (!selectedGroupId || joueurIdToNom.size === 0) return new Map();

        try {
            // 1. Charger les jointures avec le nom du jeu via la relation
            const { data: jointureData, error: jointureError } = await supabase
                .from('parties_joueurs')
                .select('partie_id, joueur_id, est_gagnant, parties(nom_jeu)')
                .eq('parties.groupe_id', selectedGroupId); 

            if (jointureError) throw jointureError;

            const stats = new Map(); 
            const partiesComptees = new Set(); // Pour compter chaque partie une seule fois

            jointureData.forEach(line => {
                const nomJeu = line.parties.nom_jeu;
                // Utilisation de la map pour obtenir le nom du joueur
                const nomJoueur = joueurIdToNom.get(line.joueur_id); 
                const partieId = line.partie_id;

                if (!stats.has(nomJeu)) {
                    stats.set(nomJeu, { parties: 0, scores: new Map() });
                }

                const jeuStats = stats.get(nomJeu);

                // Compter le nombre de parties jou√©es
                if (!partiesComptees.has(`${nomJeu}-${partieId}`)) {
                    jeuStats.parties++;
                    partiesComptees.add(`${nomJeu}-${partieId}`);
                }

                // Compter les victoires
                if (line.est_gagnant && nomJoueur) {
                    const currentScore = jeuStats.scores.get(nomJoueur) || 0;
                    jeuStats.scores.set(nomJoueur, currentScore + 1);
                }
            });

            partiesStats = stats;
            return stats;

        } catch (error) {
            console.error("Erreur lors du chargement des statistiques de parties:", error);
            return new Map();
        }
    }

    // --- Fonctions CRUD des jeux ---
    async function chargerJeux() {
        try {
            const { data, error } = await supabase
                .from('jeux')
                .select('*, proprietaires(nom)')
                .eq('groupe_id', selectedGroupId)
                .order('nom', { ascending: true }); 
            if (error) throw error;
            return data;
        } catch (error) {
            console.error("Erreur lors du chargement des jeux:", error);
            alert(`Une erreur est survenue lors du chargement des jeux: ${error.message}`);
            return [];
        }
    }

    async function ajouterJeu(jeuData) {
        try {
            const { data, error } = await supabase
                .from('jeux')
                .insert({ ...jeuData, groupe_id: selectedGroupId })
                .select();
            if (error) throw error;
            return { success: true, data: data[0] };
        } catch (error) {
            console.error("Erreur lors de l'ajout du jeu:", error);
            alert(`Une erreur est survenue lors de l'ajout du jeu: ${error.message}`);
            return { success: false, error };
        }
    }

    async function modifierJeu(id, jeuData) {
        try {
            const { data, error } = await supabase
                .from('jeux')
                .update(jeuData)
                .eq('id', id)
                .select();
            if (error) throw error;
            return { success: true, data: data[0] };
        } catch (error) {
            console.error("Erreur lors de la modification du jeu:", error);
            alert(`Une erreur est survenue lors de la modification du jeu: ${error.message}`);
            return { success: false, error };
        }
    }

    async function supprimerJeu(id) {
        try {
            const jeuASupprimer = jeux.find(j => j.id === id);
            if (jeuASupprimer && Array.isArray(jeuASupprimer.photos) && jeuASupprimer.photos.length > 0) {
                await supprimerPhotos(jeuASupprimer.photos);
            }
            const { error } = await supabase
                .from('jeux')
                .delete()
                .eq('id', id);
            if (error) throw error;
            return { success: true };
        } catch (error) {
            console.error("Erreur lors de la suppression du jeu:", error);
            alert(`Une erreur est survenue lors de la suppression du jeu: ${error.message}`);
            return { success: false, error };
        }
    }

    // --- Fonctions de contr√¥le et d'affichage ---
    
    async function chargerEtAfficherJeux() {
        if (!selectedGroupId) return;
        
        console.log("Chargement et affichage des jeux et stats...");
        
        // 1. Charger joueurs et cr√©er la map (pour les stats)
        joueurs = await chargerJoueurs();
        joueurIdToNom.clear();
        joueurs.forEach(j => joueurIdToNom.set(j.id, j.nom));

        // 2. Charger les jeux et les statistiques 
        await Promise.all([
            chargerJeux().then(data => jeux = data),
            chargerStatistiquesParties() 
        ]);
        
        afficherListeJeux();
    }


    function afficherListeJeux() {
        listeJeux.innerHTML = '';
        const filterText = inputRecherche.value.toLowerCase();
        
        let jeuxFiltres = [...jeux].sort((a, b) => a.nom.localeCompare(b.nom)).filter(jeu => {
            if (filterText && !jeu.nom.toLowerCase().includes(filterText)) return false;
            if (currentAlphaFilter && !jeu.nom.toLowerCase().startsWith(currentAlphaFilter.toLowerCase())) return false;
            return true;
        });

        if (jeuxFiltres.length === 0 && !filterText && !currentAlphaFilter) {
            listeJeux.innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">Aucun jeu n\'est enregistr√©. Ajoutez-en un !</p>';
            return;
        }
        if (jeuxFiltres.length === 0) {
            listeJeux.innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">Aucun jeu ne correspond √† vos crit√®res de recherche.</p>';
            return;
        }
        
        jeuxFiltres.forEach((jeu) => {
            const card = document.createElement('div');
            card.className = 'jeu-card';
            
            // Image
            const img = document.createElement('img');
            img.src = (jeu.photos && jeu.photos.length > 0)
                ? jeu.photos[0]
                : 'https://via.placeholder.com/280x160?text=Pas+de+photo';
            img.alt = `Image de ${jeu.nom}`;
            card.appendChild(img);
            
            // Tags (Propri√©taire / Emprunt√© / Pr√™t√©)
            if (jeu.proprietaires && jeu.proprietaires.nom) {
                const tagProprietaire = document.createElement('span');
                tagProprietaire.className = 'tag-proprietaire';
                tagProprietaire.textContent = `Propri√©taire : ${jeu.proprietaires.nom}`;
                card.appendChild(tagProprietaire);
            }
            if (jeu.emprunte) {
                const tagEmprunte = document.createElement('span');
                tagEmprunte.className = 'tag-emprunte';
                tagEmprunte.textContent = `EMPRUNT√â${jeu.emprunte_a ? ` √Ä ${jeu.emprunte_a.toUpperCase()}` : ''}`;
                card.appendChild(tagEmprunte);
            }
            if (jeu.prete) {
                const overlayPrete = document.createElement('div');
                overlayPrete.className = 'overlay-prete';
                const overlayText = document.createElement('span');
                overlayText.className = 'text';
                overlayText.textContent = `PR√äT√â${jeu.prete_a ? ` √Ä ${jeu.prete_a.toUpperCase()}` : ''}`;
                overlayPrete.appendChild(overlayText);
                card.appendChild(overlayPrete);
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'jeu-content';
            
            const titre = document.createElement('h3');
            titre.textContent = jeu.nom;
            contentDiv.appendChild(titre);
            
            // Infos Joueurs
            const infosComplementaires = document.createElement('div');
            infosComplementaires.className = 'infos-complementaires';
            if (jeu.min_joueurs && jeu.max_joueurs && !isNaN(jeu.min_joueurs) && !isNaN(jeu.max_joueurs)) {
                const joueursIcons = document.createElement('p');
                let joueursTexte = '';
                const minEmojis = '&#128100;'.repeat(jeu.min_joueurs);
                const maxEmojis = '&#128100;'.repeat(jeu.max_joueurs);
                if (jeu.min_joueurs === jeu.max_joueurs) {
                    joueursTexte = `${minEmojis}`;
                } else {
                    joueursTexte = `${minEmojis} - ${maxEmojis}`;
                }
                joueursIcons.innerHTML = `<span>${joueursTexte} (${jeu.min_joueurs}-${jeu.max_joueurs})</span> <span class="info-label">Joueurs</span>`;
                infosComplementaires.appendChild(joueursIcons);
            }
            contentDiv.appendChild(infosComplementaires);
            
            // Statistiques (Victoires / Meilleur joueur)
            const jeuStats = partiesStats.get(jeu.nom) || { parties: 0, scores: new Map() };
            const nbParties = jeuStats.parties;
            const scores = jeuStats.scores; 

            let meilleur = null;
            let max = 0;
            
            for (const [joueur, score] of scores.entries()) {
                if (score > max) {
                    max = score;
                    meilleur = joueur;
                }
            }

            const stats = document.createElement('div');
            stats.className = 'stats';
            stats.innerHTML = `
                Parties jou√©es : <strong>${nbParties}</strong><br>
                Meilleur joueur : <strong>${meilleur ? `${meilleur} (${max} victoire${max > 1 ? 's' : ''})` : 'Aucun'}</strong>
            `;
            contentDiv.appendChild(stats);
            
            // Boutons d'action
            const btns = document.createElement('div');
            btns.className = 'btns-card';
            
            const btnModifier = document.createElement('button');
            btnModifier.className = 'btn-card btn-modifier';
            btnModifier.textContent = '‚úèÔ∏è Modifier';
            btnModifier.addEventListener('click', (event) => {
                event.stopPropagation();
                ouvrirModaleModifier(jeu.id);
            });
            btns.appendChild(btnModifier);
            
            const btnSupprimer = document.createElement('button');
            btnSupprimer.className = 'btn-card btn-supprimer';
            btnSupprimer.textContent = 'üóëÔ∏è Supprimer';
            btnSupprimer.addEventListener('click', async (event) => {
                event.stopPropagation();
                if (confirm(`Supprimer le jeu "${jeu.nom}" ?`)) {
                    const result = await supprimerJeu(jeu.id);
                    if (result.success) {
                        alert(`Jeu "${jeu.nom}" supprim√© avec succ√®s !`);
                        await chargerEtAfficherJeux();
                    } else {
                        console.error("Erreur lors de la suppression:", result.error);
                    }
                }
            });
            btns.appendChild(btnSupprimer);
            
            const btnParties = document.createElement('button');
            btnParties.className = 'btn-card btn-parties';
            btnParties.textContent = '‚ñ∂Ô∏è Voir parties';
            btnParties.addEventListener('click', (event) => {
                event.stopPropagation();
                window.location.href = `parties.html?jeu=${encodeURIComponent(jeu.nom)}`;
            });
            btns.appendChild(btnParties);
            
            contentDiv.appendChild(btns);
            card.appendChild(contentDiv);
            listeJeux.appendChild(card);
        });
    }

    // --- Gestion de la Modale et des Formulaires ---
    
    function resetForm() {
        formAjout.reset();
        jeuIdInput.value = '';
        btnSubmit.textContent = 'Ajouter le jeu';
        photosPreviewContainer.style.display = 'none';
        photosPreviewDiv.innerHTML = '';
        oldPhotosUrls = [];
        // Masquer les champs de pr√™t/emprunt
        preteAInput.style.display = 'none';
        emprunteAInput.style.display = 'none';
    }

    btnAdd.addEventListener('click', () => {
        resetForm();
        modal.style.display = 'flex';
    });
    
    btnFermer.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    // √âcouteur pour masquer/afficher le champ Pr√™t√© √Ä
    preteCheckbox.addEventListener('change', () => {
        preteAInput.style.display = preteCheckbox.checked ? 'block' : 'none';
        if (!preteCheckbox.checked) preteAInput.value = '';
    });
    
    // √âcouteur pour masquer/afficher le champ Emprunt√© √Ä
    emprunteCheckbox.addEventListener('change', () => {
        emprunteAInput.style.display = emprunteCheckbox.checked ? 'block' : 'none';
        if (!emprunteCheckbox.checked) emprunteAInput.value = '';
    });

    function ouvrirModaleModifier(id) {
        resetForm();
        const jeu = jeux.find(j => j.id === id);
        if (!jeu) return alert("Erreur: Impossible de charger les donn√©es du jeu.");

        jeuIdInput.value = jeu.id;
        nomJeuInput.value = jeu.nom;
        proprietaireJeuSelect.value = jeu.proprietaire_id || '';
        minJoueursInput.value = jeu.min_joueurs !== undefined ? jeu.min_joueurs : '';
        maxJoueursInput.value = jeu.max_joueurs !== undefined ? jeu.max_joueurs : '';
        
        preteCheckbox.checked = jeu.prete === true;
        preteAInput.value = jeu.prete_a || '';
        preteAInput.style.display = preteCheckbox.checked ? 'block' : 'none';
        
        emprunteCheckbox.checked = jeu.emprunte === true;
        emprunteAInput.value = jeu.emprunte_a || '';
        emprunteAInput.style.display = emprunteCheckbox.checked ? 'block' : 'none';

        oldPhotosUrls = Array.isArray(jeu.photos) ? [...jeu.photos] : [];
        photosPreviewDiv.innerHTML = '';
        if (oldPhotosUrls.length > 0) {
            photosPreviewContainer.style.display = 'block';
            oldPhotosUrls.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.style.width = '100px';
                img.style.height = '60px';
                img.style.objectFit = 'cover';
                img.style.border = '1px solid #ccc';
                photosPreviewDiv.appendChild(img);
            });
        } else {
            photosPreviewContainer.style.display = 'none';
        }

        btnSubmit.textContent = 'Modifier le jeu';
        modal.style.display = 'flex';
    }

    formAjout.addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = jeuIdInput.value;
        const photosFiles = photosJeuInput.files;
        
        btnSubmit.disabled = true;
        btnSubmit.textContent = id ? "Modification..." : "Ajout...";

        let newPhotosUrls = [];
        if (photosFiles.length > 0) {
            newPhotosUrls = await uploaderPhotos(photosFiles);
        }

        const finalPhotosUrls = [...oldPhotosUrls, ...newPhotosUrls];
        
        const jeuData = {
            nom: nomJeuInput.value,
            proprietaire_id: proprietaireJeuSelect.value || null,
            photos: finalPhotosUrls,
            min_joueurs: parseInt(minJoueursInput.value, 10) || null,
            max_joueurs: parseInt(maxJoueursInput.value, 10) || null,
            prete: preteCheckbox.checked,
            prete_a: preteCheckbox.checked ? preteAInput.value : null,
            emprunte: emprunteCheckbox.checked,
            emprunte_a: emprunteCheckbox.checked ? emprunteAInput.value : null
        };
        
        let result;
        if (id) {
            result = await modifierJeu(parseInt(id, 10), jeuData);
        } else {
            result = await ajouterJeu(jeuData);
        }
        
        btnSubmit.disabled = false;
        
        if (result.success) {
            alert(`Jeu ${id ? 'modifi√©' : 'ajout√©'} avec succ√®s !`);
            modal.style.display = 'none';
            await chargerEtAfficherJeux();
        } else {
            // Afficher l'erreur est g√©r√© dans les fonctions CRUD
        }
    });


    // --- Filtres alphab√©tiques ---
    function generateAlphaFilters() {
        alphaFilterContainer.innerHTML = '';
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

        const allBtn = document.createElement('button');
        allBtn.textContent = 'Tous';
        allBtn.className = 'alpha-filter-btn active';
        allBtn.setAttribute('data-filter', '');
        allBtn.addEventListener('click', handleAlphaFilter);
        alphaFilterContainer.appendChild(allBtn);

        letters.forEach(letter => {
            const btn = document.createElement('button');
            btn.textContent = letter;
            btn.className = 'alpha-filter-btn';
            btn.setAttribute('data-filter', letter);
            btn.addEventListener('click', handleAlphaFilter);
            alphaFilterContainer.appendChild(btn);
        });
    }

    function handleAlphaFilter(e) {
        currentAlphaFilter = e.target.getAttribute('data-filter');
        document.querySelectorAll('.alpha-filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        inputRecherche.value = '';
        afficherListeJeux();
    }

    // --- √âcouteurs restants ---
    proprietaireJeuSelect.addEventListener('change', (e) => {
        if (e.target.value === 'ajouter-proprietaire') {
            ajouterNouveauProprietaire();
        }
    });

    inputRecherche.addEventListener('input', () => {
        currentAlphaFilter = '';
        document.querySelectorAll('.alpha-filter-btn').forEach(b => b.classList.remove('active'));
        const allBtn = document.querySelector('.alpha-filter-btn[data-filter=""]');
        if (allBtn) allBtn.classList.add('active');
        afficherListeJeux();
    });

    // --- Lancement ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (!await checkAuthAndGroup()) return;
        generateAlphaFilters();
        await chargerProprietaires();
        await chargerEtAfficherJeux();
    });

    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        if (selectedGroupId) await chargerEtAfficherJeux();
      }
    });
  </script>

  <script>
    // Script Service Worker (inchang√©)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
  </script>
</body>
</html>