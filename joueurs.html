<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Oh My Games - Joueurs</title>
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Styles sp√©cifiques pour le tableau des joueurs */
        #joueurs-list {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }
        #joueurs-list th, #joueurs-list td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        #joueurs-list th {
            background-color: #f2f2f2;
            cursor: pointer;
        }
        .add-player-form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        .add-player-form input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
            max-width: 250px;
        }
        .add-player-form button {
            padding: 8px 15px;
        }
        .info-message {
            margin-top: 15px;
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Oh My Games</h1>
    <h2>Gestion des Joueurs</h2>
    <img src="omg_img.png" alt="Fond" class="background-image">

    <div class="add-player-form">
        <input type="text" id="new-joueur-nom" placeholder="Nom du joueur" required>
        <button id="btn-add-joueur">Ajouter le joueur</button>
    </div>

    <table id="joueurs-list">
        <thead>
            <tr>
                <th>Nom/Alias</th>
                <th onclick="sortTable(1)">Parties Jou√©es</th>
                <th onclick="sortTable(2)">Victoires</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="joueurs-tbody">
            <tr><td colspan="4" class="info-message">Chargement des joueurs...</td></tr>
        </tbody>
    </table>
    
    <div id="status-message" class="info-message"></div>

    <button class="btn-home" onclick="location.href='index.html'">üè† Home</button>

    <script type="module">
        import { supabase } from './supabase-config.js';

        // --- V√©rification et r√©cup√©ration du Groupe ---
        const selectedGroupId = localStorage.getItem('selected_group_id');
        if (!selectedGroupId) {
            // Redirection si aucun groupe s√©lectionn√©
            alert("Veuillez s√©lectionner un groupe.");
            location.href = 'login.html';
            throw new Error("Groupe non s√©lectionn√©.");
        }
        // ---------------------------------------------

        // --- R√©f√©rences DOM ---
        const joueursTbody = document.getElementById('joueurs-tbody');
        const statusMessage = document.getElementById('status-message');
        const newJoueurNomInput = document.getElementById('new-joueur-nom');
        const btnAddJoueur = document.getElementById('btn-add-joueur');

        // --- Fonctions Supabase (Filtr√©es par Groupe) ---

        async function chargerJoueurs() {
            // R√©cup√®re TOUS les joueurs li√©s au groupe s√©lectionn√©
            const { data, error } = await supabase
                .from('joueurs')
                .select('*')
                .eq('groupe_id', selectedGroupId) // CRITIQUE : Filtre par groupe
                .order('nom', { ascending: true });
            
            if (error) {
                console.error("Erreur lors du chargement des joueurs:", error);
                return [];
            }
            return data;
        }

        async function chargerParties() {
            // R√©cup√®re TOUTES les parties jou√©es par ce groupe
            const { data, error } = await supabase
                .from('parties')
                .select('gagnant')
                .eq('groupe_id', selectedGroupId); // CRITIQUE : Filtre par groupe

            if (error) {
                console.error("Erreur lors du chargement des parties:", error);
                return [];
            }
            return data;
        }

        // --- Logique d'Agr√©gation et d'Affichage ---

        async function loadPlayerStats() {
            joueursTbody.innerHTML = '<tr><td colspan="4" class="info-message">Chargement des donn√©es...</td></tr>';
            statusMessage.textContent = '';

            const [joueursData, partiesData] = await Promise.all([
                chargerJoueurs(),
                chargerParties()
            ]);

            if (joueursData.length === 0) {
                joueursTbody.innerHTML = '<tr><td colspan="4" class="info-message">Aucun joueur dans ce groupe.</td></tr>';
                return;
            }

            const victoiresParJoueur = {};
            const partiesJoueesParJoueur = {}; 

            // Initialisation des compteurs pour tous les joueurs du groupe
            joueursData.forEach(joueur => {
                const nom = joueur.nom.trim();
                victoiresParJoueur[nom] = 0;
                partiesJoueesParJoueur[nom] = 0;
            });

            // 1. Parcourir toutes les parties filtr√©es par groupe
            partiesData.forEach(partie => {
                let gagnants = [];
                try {
                    // Si le champ 'gagnant' stocke un tableau JSON (plusieurs gagnants)
                    gagnants = JSON.parse(partie.gagnant);
                    if (!Array.isArray(gagnants)) {
                        gagnants = [gagnants];
                    }
                } catch (e) {
                    // Si c'est juste une cha√Æne de caract√®res
                    if (partie.gagnant && partie.gagnant.trim() !== "") {
                         gagnants = [partie.gagnant];
                    }
                }
                
                // CRITIQUE : Compter les victoires uniquement pour les joueurs du groupe
                gagnants.forEach(gagnantNom => {
                    const nom = String(gagnantNom).trim();
                    if (victoiresParJoueur.hasOwnProperty(nom)) {
                        victoiresParJoueur[nom]++;
                    }
                });
                
                // NOTE : Si la table 'parties' incluait une liste de participants,
                // il faudrait la d√©coder ici pour incr√©menter partiesJoueesParJoueur.
                // Sans cette liste, nous nous concentrons uniquement sur les victoires.
                // Par simplification, nous laissons 'Parties Jou√©es' √† 0 ou √† une valeur par d√©faut.
                // Si vous avez un champ participants dans 'parties', ajustez ici.
            });
            
            // Mise √† jour de la table HTML
            joueursTbody.innerHTML = '';
            joueursData.forEach(joueur => {
                const tr = document.createElement('tr');
                const nom = joueur.nom.trim();
                const victoires = victoiresParJoueur[nom] || 0;
                
                tr.dataset.joueurId = joueur.id; // Pour les actions (suppression)
                tr.dataset.victoires = victoires; // Pour le tri
                tr.dataset.parties = 0; // D√©faut, car non calcul√©

                // Affichage du nom et alias
                const nomCell = document.createElement('td');
                nomCell.textContent = joueur.alias || joueur.nom;
                tr.appendChild(nomCell);

                // Parties jou√©es (simplifi√© √† 0 car nous n'avons pas la liste des participants par partie)
                const partiesCell = document.createElement('td');
                partiesCell.textContent = '-'; 
                tr.appendChild(partiesCell);

                // Victoires
                const victoiresCell = document.createElement('td');
                victoiresCell.textContent = victoires;
                tr.appendChild(victoiresCell);

                // Actions
                const actionsCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Supprimer';
                deleteButton.onclick = () => handleDelete(joueur.id, joueur.nom);
                actionsCell.appendChild(deleteButton);
                tr.appendChild(actionsCell);

                joueursTbody.appendChild(tr);
            });
        }

        // --- Logique d'ajout et de suppression ---

        btnAddJoueur.addEventListener('click', async () => {
            const nom = newJoueurNomInput.value.trim();
            if (!nom) {
                alert("Le nom du joueur ne peut pas √™tre vide.");
                return;
            }

            statusMessage.textContent = 'Ajout en cours...';

            const { error } = await supabase
                .from('joueurs')
                .insert([
                    { nom: nom, alias: nom, groupe_id: selectedGroupId } // Lier au groupe
                ]);

            if (error) {
                console.error("Erreur d'ajout:", error);
                if (error.code === '23505') {
                    statusMessage.textContent = "Erreur: Ce joueur existe d√©j√† dans ce groupe.";
                } else {
                    statusMessage.textContent = "Erreur lors de l'ajout du joueur.";
                }
            } else {
                newJoueurNomInput.value = '';
                statusMessage.textContent = `Joueur "${nom}" ajout√© avec succ√®s.`;
                loadPlayerStats();
            }
        });

        async function handleDelete(id, nom) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le joueur "${nom}" ?`)) return;

            statusMessage.textContent = `Suppression de "${nom}"...`;

            const { error } = await supabase
                .from('joueurs')
                .delete()
                .eq('id', id)
                .eq('groupe_id', selectedGroupId); // S√©curit√© suppl√©mentaire

            if (error) {
                console.error("Erreur de suppression:", error);
                statusMessage.textContent = "Erreur lors de la suppression du joueur.";
            } else {
                statusMessage.textContent = `Joueur "${nom}" supprim√©.`;
                loadPlayerStats();
            }
        }

        // --- Fonction de tri (simplifi√©e) ---

        let sortDirection = 'asc';
        let sortedColumn = -1;

        window.sortTable = (columnIndex) => {
            if (sortedColumn === columnIndex) {
                sortDirection = (sortDirection === 'asc') ? 'desc' : 'asc';
            } else {
                sortedColumn = columnIndex;
                sortDirection = 'asc';
            }

            const tbody = document.getElementById('joueurs-tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let aVal, bVal;
                
                // Utilisation des data-attributs pour les valeurs num√©riques
                if (columnIndex === 1) { // Parties Jou√©es
                    aVal = parseInt(a.dataset.parties || 0);
                    bVal = parseInt(b.dataset.parties || 0);
                } else if (columnIndex === 2) { // Victoires
                    aVal = parseInt(a.dataset.victoires || 0);
                    bVal = parseInt(b.dataset.victoires || 0);
                } else { // Tri par Nom/Alias (colonne 0)
                    aVal = a.cells[0].textContent.toLowerCase();
                    bVal = b.cells[0].textContent.toLowerCase();
                }

                if (sortDirection === 'asc') {
                    return (aVal > bVal) ? 1 : (aVal < bVal) ? -1 : 0;
                } else {
                    return (aVal < bVal) ? 1 : (aVal > bVal) ? -1 : 0;
                }
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        };

        // Chargement initial des donn√©es
        document.addEventListener('DOMContentLoaded', loadPlayerStats);
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                loadPlayerStats();
            }
        });

    </script>
</body>
</html>