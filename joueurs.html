<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oh My Games - Joueurs</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="group-info" style="text-align: right; margin-top: 10px; margin-right: 10px;">
        <span id="current-group-alias"></span>
        <button onclick="location.href='login.html'" style="margin-left: 10px;">Changer de groupe</button>
    </div>
    <h1>Oh My Games</h1>
    <h2>Liste des joueurs</h2>
    <img src="omg_img.png" alt="Fond" class="background-image" />

    <button class="btn-add">‚ûï Ajouter un joueur</button>

    <div id="alpha-filter-container">
    </div>

    <input type="text" id="recherche-joueurs" placeholder="üîç Rechercher un joueur..." />

    <div id="liste-joueurs">
    </div>

    <div id="modal-ajout" class="modal">
        <div id="modal-content" class="modal-content">
            <button id="btn-fermer" class="close-button">&times;</button>
            <h3>Ajouter/Modifier un joueur</h3>
            <form id="form-ajout">
                <input type="hidden" id="joueur-id">
                <label for="nom-joueur">Nom du joueur :</label>
                <input type="text" id="nom-joueur" name="nom-joueur" required><br><br>

                <label for="alias-joueur">Alias/Surnom (optionnel) :</label>
                <input type="text" id="alias-joueur" name="alias-joueur"><br><br>

                <label for="photo-joueur">Photo de profil (optionnel) :</label>
                <input type="file" id="photo-joueur" name="photo-joueur" accept="image/*"><br><br>

                <div id="photo-preview-container" style="display: none; margin-bottom: 10px;">
                    <p>Photo actuelle :</p>
                    <img id="photo-preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 1px solid #ccc;">
                </div>

                <button type="submit">Ajouter le joueur</button>
            </form>
        </div>
    </div>

    <button class="btn-home" onclick="location.href='index.html'">üè† Home</button>

    <script type="module">
        console.log("Script joueurs.html charg√©.");

        import { supabase } from './supabase-config.js';

        let joueurs = [];
        let parties = [];
        let jeux = [];
        const photosBucket = 'joueur-photos';

        const modal = document.getElementById('modal-ajout');
        const btnAdd = document.querySelector('.btn-add');
        const btnFermer = document.getElementById('btn-fermer');
        const formAjout = document.getElementById('form-ajout');
        const listeJoueurs = document.getElementById('liste-joueurs');
        const inputRecherche = document.getElementById('recherche-joueurs');

        const joueurIdInput = document.getElementById('joueur-id');
        const nomJoueurInput = document.getElementById('nom-joueur');
        const aliasJoueurInput = document.getElementById('alias-joueur');
        const photoJoueurInput = document.getElementById('photo-joueur');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const photoPreviewImg = document.getElementById('photo-preview');

        let currentAlphaFilter = '';
        let selectedGroupId = null;

        // --- V√©rification et affichage du groupe ---
        selectedGroupId = localStorage.getItem('selected_group_id');
        if (!selectedGroupId) {
            location.href = 'login.html';
        } else {
            const selectedGroupAlias = localStorage.getItem('selected_group_alias');
            document.getElementById('current-group-alias').textContent = `Groupe : ${selectedGroupAlias}`;
        }

        // --- Fonctions de gestion des photos avec Supabase Storage ---
        async function uploaderPhoto(photoFile) {
            if (!photoFile) return null;

            const fileExt = photoFile.name.split('.').pop();
            const fileName = `${selectedGroupId}/${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
            
            const { data, error } = await supabase.storage.from(photosBucket).upload(fileName, photoFile);

            if (error) {
                console.error("Erreur lors de l'upload de l'image:", error);
                alert(`Erreur lors de l'upload de l'image: ${error.message}`);
                return null;
            }

            const { data: urlData, error: publicUrlError } = supabase.storage.from(photosBucket).getPublicUrl(data.path);
            if (publicUrlError) {
                console.error("Erreur lors de la r√©cup√©ration de l'URL publique:", publicUrlError);
                alert(`Erreur lors de la r√©cup√©ration de l'URL publique: ${publicUrlError.message}`);
                return null;
            }

            return urlData.publicUrl;
        }

        async function supprimerPhoto(photoUrl) {
            if (!photoUrl) return;
            
            try {
                const pathSegments = photoUrl.split('/');
                const filePath = pathSegments[pathSegments.length - 2] + '/' + pathSegments[pathSegments.length - 1];

                const { error } = await supabase.storage.from(photosBucket).remove([filePath]);
                if (error) throw error;
            } catch (error) {
                console.error("Erreur lors de la suppression de l'image du storage:", error);
            }
        }

        // --- Fonctions de chargement des donn√©es ---
        async function chargerJoueurs() {
            try {
                const { data, error } = await supabase
                    .from('joueurs')
                    .select('*')
                    .eq('groupe_id', selectedGroupId)
                    .order('nom', { ascending: true });
                if (error) throw error;
                return data;
            } catch (error) {
                console.error("Erreur lors du chargement des joueurs:", error);
                alert(`Une erreur est survenue lors du chargement des joueurs: ${error.message}`);
                return [];
            }
        }

        async function chargerParties() {
            try {
                const { data, error } = await supabase
                    .from('parties')
                    .select('*')
                    .eq('groupe_id', selectedGroupId);
                if (error) throw error;
                return data;
            } catch (error) {
                console.error("Erreur lors du chargement des parties:", error);
                return [];
            }
        }

        async function chargerJeux() {
            try {
                // Chargement des jeux pour identifier les propri√©taires si n√©cessaire
                const { data, error } = await supabase
                    .from('jeux')
                    .select('id, nom')
                    .eq('groupe_id', selectedGroupId);
                if (error) throw error;
                return data;
            } catch (error) {
                console.error("Erreur lors du chargement des jeux:", error);
                return [];
            }
        }

        // --- Fonctions d'ajout/modification/suppression ---
        async function ajouterJoueur(joueurData) {
            try {
                const { data, error } = await supabase
                    .from('joueurs')
                    .insert({ ...joueurData, groupe_id: selectedGroupId })
                    .select();
                if (error) throw error;
                return { success: true, data: data[0] };
            } catch (error) {
                console.error("Erreur lors de l'ajout du joueur:", error);
                alert(`Une erreur est survenue lors de l'ajout du joueur: ${error.message}`);
                return { success: false, error };
            }
        }

        async function modifierJoueur(id, joueurData) {
            try {
                const { data, error } = await supabase
                    .from('joueurs')
                    .update(joueurData)
                    .eq('id', id)
                    .select();
                if (error) throw error;
                return { success: true, data: data[0] };
            } catch (error) {
                console.error("Erreur lors de la modification du joueur:", error);
                alert(`Une erreur est survenue lors de la modification du joueur: ${error.message}`);
                return { success: false, error };
            }
        }

        async function supprimerJoueur(id) {
            try {
                const joueurASupprimer = joueurs.find(j => j.id === id);
                if (joueurASupprimer && joueurASupprimer.photo_url) {
                    await supprimerPhoto(joueurASupprimer.photo_url);
                }
                const { error } = await supabase
                    .from('joueurs')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                return { success: true };
            } catch (error) {
                console.error("Erreur lors de la suppression du joueur:", error);
                alert(`Une erreur est survenue lors de la suppression du joueur: ${error.message}`);
                return { success: false, error };
            }
        }

        // --- Listeners et fonctions d'affichage ---

        btnAdd.addEventListener('click', () => {
            formAjout.reset();
            joueurIdInput.value = '';
            formAjout.querySelector('button[type="submit"]').textContent = 'Ajouter le joueur';
            photoPreviewContainer.style.display = 'none';
            photoJoueurInput.value = '';
            modal.style.display = 'flex';
        });

        btnFermer.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        formAjout.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = joueurIdInput.value;
            const nomJoueur = nomJoueurInput.value.trim();
            const aliasJoueur = aliasJoueurInput.value.trim();
            const photoFile = photoJoueurInput.files[0];
            const joueurExistant = joueurs.find(j => j.id === id);
            let photoUrl = (joueurExistant && joueurExistant.photo_url) || null;

            if (!nomJoueur) {
                alert('Le nom du joueur est obligatoire.');
                return;
            }

            if (photoFile) {
                // Si une nouvelle photo est s√©lectionn√©e, supprimer l'ancienne et uploader la nouvelle
                if (photoUrl) {
                    await supprimerPhoto(photoUrl);
                }
                photoUrl = await uploaderPhoto(photoFile);
                if (!photoUrl) return; // √âchec de l'upload
            }

            const joueurData = {
                nom: nomJoueur,
                alias: aliasJoueur || null,
                photo_url: photoUrl,
            };

            let result;
            if (id) {
                result = await modifierJoueur(id, joueurData);
            } else {
                result = await ajouterJoueur(joueurData);
            }

            if (result.success) {
                alert(`Joueur "${nomJoueur}" ${id ? 'modifi√©' : 'ajout√©'} avec succ√®s !`);
                await chargerEtAfficherJoueurs();
                modal.style.display = 'none';
                formAjout.reset();
                photoJoueurInput.value = '';
            }
        });

        function generateAlphaFilters() {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const alphaFilterContainer = document.getElementById('alpha-filter-container');
            alphaFilterContainer.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = 'alpha-filter-btn';
            if (currentAlphaFilter === '') allBtn.classList.add('active');
            allBtn.textContent = 'Tout';
            allBtn.setAttribute('data-filter', '');
            alphaFilterContainer.appendChild(allBtn);
            alphabet.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'alpha-filter-btn';
                if (currentAlphaFilter === letter) btn.classList.add('active');
                btn.textContent = letter;
                btn.setAttribute('data-filter', letter);
                alphaFilterContainer.appendChild(btn);
            });
            alphaFilterContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('alpha-filter-btn')) {
                    document.querySelectorAll('.alpha-filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentAlphaFilter = e.target.getAttribute('data-filter');
                    inputRecherche.value = '';
                    afficherListeJoueurs();
                }
            });
        }

        async function chargerEtAfficherJoueurs() {
            console.log("Chargement et affichage des joueurs, parties et jeux depuis Supabase...");
            joueurs = await chargerJoueurs();
            parties = await chargerParties();
            jeux = await chargerJeux(); // N√©cessaire pour les statistiques de propri√©t√©
            afficherListeJoueurs();
        }

        function afficherListeJoueurs() {
            console.log("Affichage de la liste des joueurs...");
            listeJoueurs.innerHTML = '';
            const filterText = inputRecherche.value.toLowerCase();
            const joueursTries = [...joueurs].sort((a, b) => a.nom.localeCompare(b.nom));

            if (joueursTries.length === 0 && !filterText && !currentAlphaFilter) {
                listeJoueurs.innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">Aucun joueur n\'est enregistr√©. Ajoutez-en un !</p>';
                return;
            }

            let joueursFiltres = joueursTries.filter(joueur => {
                const nomComplet = (joueur.nom + (joueur.alias || '')).toLowerCase();
                if (filterText && !nomComplet.includes(filterText)) {
                    return false;
                }
                if (currentAlphaFilter && !joueur.nom.toLowerCase().startsWith(currentAlphaFilter.toLowerCase())) {
                    return false;
                }
                return true;
            });

            if (joueursFiltres.length === 0) {
                listeJoueurs.innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">Aucun joueur ne correspond √† vos crit√®res de recherche.</p>';
                return;
            }

            joueursFiltres.forEach((joueur) => {
                const card = document.createElement('div');
                card.className = 'joueur-card';

                // --- Photo et nom ---
                const headerDiv = document.createElement('div');
                headerDiv.className = 'joueur-header';
                const img = document.createElement('img');
                img.src = joueur.photo_url || 'https://via.placeholder.com/100x100?text=üë§';
                img.alt = `Photo de ${joueur.nom}`;
                img.className = 'joueur-photo';
                headerDiv.appendChild(img);

                const nomAliasDiv = document.createElement('div');
                nomAliasDiv.className = 'joueur-nom-alias';
                const titre = document.createElement('h3');
                titre.textContent = joueur.nom;
                nomAliasDiv.appendChild(titre);
                if (joueur.alias) {
                    const alias = document.createElement('p');
                    alias.className = 'joueur-alias';
                    alias.textContent = `(${joueur.alias})`;
                    nomAliasDiv.appendChild(alias);
                }
                headerDiv.appendChild(nomAliasDiv);
                card.appendChild(headerDiv);

                // --- Calcul des Statistiques ---
                let partiesJouees = 0;
                let victoires = 0;
                const partiesGagneesParJeu = {};
                const jeuxJoues = new Set();
                
                // Utiliser le nom ou l'alias pour le comptage
                const joueurNames = [joueur.nom.toLowerCase(), (joueur.alias || '').toLowerCase()].filter(n => n);

                parties.forEach(p => {
                    let participants = [];
                    let gagnants = [];

                    try {
                        participants = JSON.parse(p.participants);
                        gagnants = p.gagnant ? JSON.parse(p.gagnant) : [];
                    } catch (e) {
                        // Cas des anciennes donn√©es non JSON
                        participants = p.participants ? p.participants.split(',').map(n => n.trim()) : [];
                        gagnants = p.gagnant ? p.gagnant.split(',').map(n => n.trim()) : [];
                    }

                    const estParticipant = participants.some(name => joueurNames.includes(name.toLowerCase()));
                    if (estParticipant) {
                        partiesJouees++;
                        jeuxJoues.add(p.nom_jeu);
                        
                        const estGagnant = gagnants.some(name => joueurNames.includes(name.toLowerCase()));
                        if (estGagnant) {
                            victoires++;
                            partiesGagneesParJeu[p.nom_jeu] = (partiesGagneesParJeu[p.nom_jeu] || 0) + 1;
                        }
                    }
                });
                
                let jeuFavori = 'Aucun';
                let maxVictoires = 0;
                for (const [jeu, count] of Object.entries(partiesGagneesParJeu)) {
                    if (count > maxVictoires) {
                        maxVictoires = count;
                        jeuFavori = jeu;
                    }
                }

                // V√©rifier si le joueur est propri√©taire d'un jeu
                const estProprietaire = jeux.some(jeu => jeu.proprietaire_id === joueur.id);

                // --- Affichage des Statistiques ---
                const statsDiv = document.createElement('div');
                statsDiv.className = 'joueur-stats';
                statsDiv.innerHTML = `
                    <p>Parties Jou√©es : <strong>${partiesJouees}</strong></p>
                    <p>Victoires : <strong>${victoires}</strong></p>
                    <p>Ratio Victoires : <strong>${partiesJouees > 0 ? ((victoires / partiesJouees) * 100).toFixed(1) + '%' : 'N/A'}</strong></p>
                    <p>Jeux Jou√©s : <strong>${jeuxJoues.size}</strong></p>
                    <p>Jeu Favori : <strong>${jeuFavori}</strong></p>
                    <p>${estProprietaire ? 'üëë' : '‚úñÔ∏è'} Propri√©taire de jeux</p>
                `;
                card.appendChild(statsDiv);


                // --- Boutons ---
                const btns = document.createElement('div');
                btns.className = 'btns-card';

                const btnModifier = document.createElement('button');
                btnModifier.className = 'btn-card btn-modifier';
                btnModifier.textContent = '‚úèÔ∏è Modifier';
                btnModifier.addEventListener('click', (event) => {
                    event.stopPropagation();
                    ouvrirModaleModifier(joueur.id);
                });
                btns.appendChild(btnModifier);

                const btnSupprimer = document.createElement('button');
                btnSupprimer.className = 'btn-card btn-supprimer';
                btnSupprimer.textContent = 'üóëÔ∏è Supprimer';
                btnSupprimer.addEventListener('click', async (event) => {
                    event.stopPropagation();
                    if (confirm(`Supprimer le joueur "${joueur.nom}" ? Cela ne supprime pas les parties enregistr√©es, mais il ne sera plus disponible pour de nouvelles parties.`)) {
                        const result = await supprimerJoueur(joueur.id);
                        if (result.success) {
                            alert(`Joueur "${joueur.nom}" supprim√© avec succ√®s !`);
                            await chargerEtAfficherJoueurs();
                        } else {
                            console.error("Erreur lors de la suppression:", result.error);
                        }
                    }
                });
                btns.appendChild(btnSupprimer);

                card.appendChild(btns);
                listeJoueurs.appendChild(card);
            });
        }

        function ouvrirModaleModifier(id) {
            console.log("Ouverture modale pour modification, ID:", id);
            const joueur = joueurs.find(j => j.id === id);
            if (!joueur) {
                console.error("Joueur non trouv√© avec l'ID:", id);
                alert("Erreur: Impossible de charger les donn√©es du joueur.");
                return;
            }

            joueurIdInput.value = joueur.id;
            nomJoueurInput.value = joueur.nom;
            aliasJoueurInput.value = joueur.alias || '';
            photoJoueurInput.value = ''; // R√©initialiser le champ file

            if (joueur.photo_url) {
                photoPreviewContainer.style.display = 'block';
                photoPreviewImg.src = joueur.photo_url;
            } else {
                photoPreviewContainer.style.display = 'none';
            }

            formAjout.querySelector('button[type="submit"]').textContent = 'Modifier le joueur';
            modal.style.display = 'flex';
        }

        inputRecherche.addEventListener('input', () => {
            currentAlphaFilter = '';
            document.querySelectorAll('.alpha-filter-btn').forEach(b => b.classList.remove('active'));
            const allBtn = document.querySelector('.alpha-filter-btn[data-filter=""]');
            if (allBtn) allBtn.classList.add('active');
            afficherListeJoueurs();
        });

        document.addEventListener('DOMContentLoaded', async () => {
            generateAlphaFilters();
            await chargerEtAfficherJoueurs();
        });

        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                await chargerEtAfficherJoueurs();
            }
        });

    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>