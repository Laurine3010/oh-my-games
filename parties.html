<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oh My Games - Parties</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Style simple pour la liste des parties */
    #historique-parties {
      margin-top: 30px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
    }
    #historique-parties table {
      width: 100%;
      border-collapse: collapse;
    }
    #historique-parties th, #historique-parties td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #historique-parties th {
      background-color: #f4f4f4;
    }

    /* Styles du formulaire d'√©dition */
    #edition-partie {
      max-width: 900px;
      margin: 20px auto;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #edition-partie h3 {
      margin-top: 0;
    }
    #edition-partie button {
      cursor: pointer;
    }
    .selected-player {
        display: inline-block;
        background-color: #e0f2ff; /* Couleur plus coh√©rente */
        border: 1px solid #b3d9ff;
        padding: 5px 10px;
        margin-right: 8px;
        margin-bottom: 8px;
        border-radius: 15px; /* Pill-like shape */
        font-size: 0.9em;
    }
    .remove-player {
        margin-left: 5px;
        cursor: pointer;
        color: #dc3545;
        font-weight: bold;
    }
    datalist {
        width: 100%;
    }
    .winner-selection {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
    .winner-selection label {
        display: block;
        margin-bottom: 5px;
    }
    /* Styles pour les sections de s√©lection des vainqueurs (radios) */
    #liste-vainqueurs, #edit-liste-vainqueurs {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        padding: 10px;
        background-color: #f0f8ff;
        border-radius: 8px;
    }
    #liste-vainqueurs label, #edit-liste-vainqueurs label {
        display: inline-flex;
        align-items: center;
        margin-bottom: 0;
        font-weight: normal;
        color: #333;
    }
    #liste-vainqueurs input[type="radio"], #edit-liste-vainqueurs input[type="radio"] {
        margin-right: 5px;
        transform: scale(1.1);
    }
  </style>
</head>
<body>
    <div id="group-info" style="text-align: right; margin-top: 10px; margin-right: 10px;">
        <span id="current-group-alias"></span>
        <button onclick="location.href='login.html'" class="btn-home" style="position: static; margin-left: 10px; padding: 5px 10px;">Changer de groupe</button>
    </div>
  <h1>Oh My Games</h1>
  <h2>Nouvelle partie</h2>

  <img src="omg_img.png" alt="Fond" class="background-image" />
  <button class="btn-home" onclick="location.href='index.html'">&#127968; Home</button>

  <form id="form-partie">
    <label for="jeu-input">Jeu :</label><br />
    <input list="jeux-list" id="jeu-input" name="jeu-input" required><br />
    <datalist id="jeux-list"></datalist><br />

    <label for="date-partie">Date de la partie :</label><br />
    <input type="datetime-local" id="date-partie" name="date-partie" required><br /><br />

    <label>Joueurs participants :</label><br />
    <input list="joueurs-list" id="joueur-input" name="joueur-input" placeholder="Rechercher un joueur"><br />
    <datalist id="joueurs-list"></datalist>
    <div id="liste-joueurs-participation" class="joueurs-list-container"></div><br />

    <label>Vainqueur(s) :</label>
    <div id="winner-selector">
      <label for="single-winner"><input type="radio" id="single-winner" name="winner-type" value="single" checked> Vainqueur unique</label>
      <label for="multiple-winners"><input type="radio" id="multiple-winners" name="winner-type" value="multiple"> Vainqueurs ex aequo</label>
    </div>
    <div id="single-winner-section">
      <div id="liste-vainqueurs" class="winner-selection"></div>
    </div>
    <div id="multiple-winners-section" style="display: none;">
      <input list="joueurs-list-multiple" id="vainqueur-input" placeholder="Rechercher un vainqueur">
      <datalist id="joueurs-list-multiple"></datalist>
      <div id="liste-vainqueurs-multiple" class="joueurs-list-container"></div>
    </div><br />

    <button type="submit" class="btn-add">Enregistrer la partie</button>
  </form>

  <section id="historique-parties">
    <h2>Historique des parties jou√©es</h2>

    <label for="filtre-jeu">Filtrer par jeu :</label>
    <select id="filtre-jeu">
      <option value="">Tous les jeux</option>
    </select>

    <label for="filtre-joueur" style="margin-left: 20px;">Filtrer par joueur :</label>
    <select id="filtre-joueur">
      <option value="">Tous les joueurs</option>
    </select>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Jeu</th>
          <th>Joueurs</th>
          <th>Vainqueur(s)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="table-body-parties"></tbody>
    </table>
  </section>

  <section id="edition-partie">
    <h3>Modifier la partie</h3>
    <form id="form-edition">
      <input type="hidden" id="partie-id-edition">
      <label for="edit-jeu-input">Jeu :</label><br />
      <input list="edit-jeux-list" id="edit-jeu-input" name="edit-jeu-input" required><br />
      <datalist id="edit-jeux-list"></datalist><br />
      
      <label for="edit-date-partie">Date de la partie :</label><br />
      <input type="datetime-local" id="edit-date-partie" name="edit-date-partie" required><br /><br />

      <label>Joueurs participants :</label><br />
      <input list="edit-joueurs-list" id="edit-joueur-input" name="edit-joueur-input" placeholder="Rechercher un joueur"><br />
      <datalist id="edit-joueurs-list"></datalist>
      <div id="edit-liste-joueurs-participation" class="joueurs-list-container"></div><br />

      <label>Vainqueur(s) :</label>
      <div id="edit-winner-selector">
        <label for="edit-single-winner"><input type="radio" id="edit-single-winner" name="edit-winner-type" value="single" checked> Vainqueur unique</label>
        <label for="edit-multiple-winners"><input type="radio" id="edit-multiple-winners" name="edit-winner-type" value="multiple"> Vainqueurs ex aequo</label>
      </div>
      <div id="edit-single-winner-section">
        <div id="edit-liste-vainqueurs" class="winner-selection"></div>
      </div>
      <div id="edit-multiple-winners-section" style="display: none;">
        <input list="edit-joueurs-list-multiple" id="edit-vainqueur-input" placeholder="Rechercher un vainqueur">
        <datalist id="edit-joueurs-list-multiple"></datalist>
        <div id="edit-liste-vainqueurs-multiple" class="joueurs-list-container"></div>
      </div><br />

      <button type="submit" class="btn-add">Sauvegarder les modifications</button>
      <button type="button" id="btn-annuler-edition" class="btn-supprimer" style="margin-left:10px;">Annuler</button>
    </form>
  </section>

  <script type="module">
    console.log("Script parties.html charg√©.");

    import { supabase } from './supabase-config.js';

    let joueurs = [];
    let jeux = [];
    let parties = []; // Utilis√© pour l'affichage de l'historique

    // Map de noms vers IDs et IDs vers noms (pour conversions rapides)
    let joueurNomToId = new Map();
    let joueurIdToNom = new Map();

    let selectedGroupId = null;

    // --- V√©rification et affichage du groupe ---
    selectedGroupId = localStorage.getItem('selected_group_id');
    if (!selectedGroupId) {
        location.href = 'login.html';
        throw new Error("Groupe non s√©lectionn√©."); // Stop execution
    } else {
        const selectedGroupAlias = localStorage.getItem('selected_group_alias');
        document.getElementById('current-group-alias').textContent = `Groupe : ${selectedGroupAlias}`;
    }

    // DOM References - New Party Form
    const jeuInput = document.getElementById('jeu-input');
    const jeuxList = document.getElementById('jeux-list');
    const datePartieInput = document.getElementById('date-partie');
    const joueurInput = document.getElementById('joueur-input');
    const joueursList = document.getElementById('joueurs-list');
    const joueursParticipationDiv = document.getElementById('liste-joueurs-participation');
    const singleWinnerRadio = document.getElementById('single-winner');
    const multipleWinnersRadio = document.getElementById('multiple-winners');
    const singleWinnerSection = document.getElementById('single-winner-section');
    const multipleWinnersSection = document.getElementById('multiple-winners-section');
    const vainqueurInput = document.getElementById('vainqueur-input');
    const joueursListMultiple = document.getElementById('joueurs-list-multiple');
    const vainqueursDiv = document.getElementById('liste-vainqueurs');
    const vainqueursMultipleDiv = document.getElementById('liste-vainqueurs-multiple');
    const formPartie = document.getElementById('form-partie');

    // DOM References - Filters & Table
    const filtreJeu = document.getElementById('filtre-jeu');
    const filtreJoueur = document.getElementById('filtre-joueur');
    const tbodyParties = document.getElementById('table-body-parties');

    // DOM References - Edit Form
    const editionSection = document.getElementById('edition-partie');
    const formEdition = document.getElementById('form-edition');
    const partieIdEditionInput = document.getElementById('partie-id-edition');
    const editJeuInput = document.getElementById('edit-jeu-input');
    const editJeuxList = document.getElementById('edit-jeux-list');
    const editDatePartieInput = document.getElementById('edit-date-partie');
    const editJoueurInput = document.getElementById('edit-joueur-input');
    const editJoueursList = document.getElementById('edit-joueurs-list');
    const editJoueursParticipationDiv = document.getElementById('edit-liste-joueurs-participation');
    const editSingleWinnerRadio = document.getElementById('edit-single-winner');
    const editMultipleWinnersRadio = document.getElementById('edit-multiple-winners');
    const editSingleWinnerSection = document.getElementById('edit-single-winner-section');
    const editMultipleWinnersSection = document.getElementById('edit-multiple-winners-section');
    const editVainqueurInput = document.getElementById('edit-vainqueur-input');
    const editJoueursListMultiple = document.getElementById('edit-joueurs-list-multiple');
    const editListeVainqueurs = document.getElementById('edit-liste-vainqueurs');
    const editVainqueursMultipleDiv = document.getElementById('edit-liste-vainqueurs-multiple');
    const btnAnnulerEdition = document.getElementById('btn-annuler-edition');

    // --- Fonctions de communication avec Supabase ---

    async function chargerJeux() {
        try {
            const { data, error } = await supabase
                .from('jeux')
                .select('id, nom')
                .eq('groupe_id', selectedGroupId); 
            if (error) throw error;
            return data;
        } catch (error) {
            console.error("Erreur lors du chargement des jeux:", error);
            return [];
        }
    }

    async function chargerJoueurs() {
        try {
            const { data, error } = await supabase
                .from('joueurs')
                .select('id, nom')
                .eq('groupe_id', selectedGroupId); 
            if (error) throw error;
            return data;
        } catch (error) {
            console.error("Erreur lors du chargement des joueurs:", error);
            return [];
        }
    }
    
    // Chargement des parties avec jointures manuelles pour r√©cup√©rer les noms
    async function chargerParties() {
        try {
            // 1. Charger la liste des parties de ce groupe
            const { data: partiesBase, error: partiesError } = await supabase
                .from('parties')
                .select('id, date, nom_jeu')
                .eq('groupe_id', selectedGroupId)
                .order('date', { ascending: false });

            if (partiesError) throw partiesError;

            const partieIds = partiesBase.map(p => p.id);

            if (partieIds.length === 0) return [];
            
            // 2. Charger toutes les lignes de jointure (participants/gagnants) pour ces parties
            const { data: jointureData, error: jointureError } = await supabase
                .from('parties_joueurs')
                .select('partie_id, joueur_id, est_gagnant')
                .in('partie_id', partieIds);

            if (jointureError) throw jointureError;
            
            // 3. Reconstruire l'objet 'parties' pour l'affichage (avec noms)
            const partiesMap = new Map(partiesBase.map(p => [p.id, {
                ...p,
                participants: [], // Liste de noms
                vainqueurs: [],    // Liste de noms
                participantIds: [], // Liste des IDs
                vainqueurIds: []    // Liste des IDs
            }]));

            jointureData.forEach(line => {
                const partie = partiesMap.get(line.partie_id);
                const nomJoueur = joueurIdToNom.get(line.joueur_id);
                
                if (partie && nomJoueur) {
                    partie.participants.push(nomJoueur);
                    partie.participantIds.push(line.joueur_id);
                    if (line.est_gagnant) {
                        partie.vainqueurs.push(nomJoueur);
                        partie.vainqueurIds.push(line.joueur_id);
                    }
                }
            });
            
            // Retourner les objets parties reconstruites (dans l'ordre tri√©)
            return Array.from(partiesMap.values()).sort((a, b) => new Date(b.date) - new Date(a.date));

        } catch (error) {
            console.error("Erreur lors du chargement des parties:", error);
            return [];
        }
    }

    // NOUVELLE LOGIQUE D'AJOUT : Double insertion
    async function ajouterPartie(partieBase, jointureLignes) {
      try {
          // 1. Insertion de la partie de base dans la table 'parties'
          const { data: newPartie, error: partieError } = await supabase
              .from('parties')
              .insert([{ ...partieBase, groupe_id: selectedGroupId }])
              .select('id')
              .single();

          if (partieError) throw partieError;

          const nouvellePartieId = newPartie.id;

          // 2. Mise √† jour de l'ID de partie dans les lignes de jointure
          const lignesAInserer = jointureLignes.map(ligne => ({
              ...ligne,
              partie_id: nouvellePartieId
          }));

          // 3. Insertion des lignes dans la table de jointure 'parties_joueurs' (CRITIQUE)
          const { error: jointureError } = await supabase
              .from('parties_joueurs')
              .insert(lignesAInserer);

          if (jointureError) throw jointureError;

          return { success: true };
      } catch (error) {
          console.error("Erreur lors de l'enregistrement de la partie:", error);
          alert(`Une erreur est survenue lors de l'enregistrement de la partie: ${error.message}`);
          return { success: false, error };
      }
    }

    // NOUVELLE LOGIQUE DE MODIFICATION : Suppression + Double insertion
    async function modifierPartie(partieId, partieBase, jointureLignes) {
      try {
          // 1. Suppression des anciennes lignes de jointure (parties_joueurs)
          const { error: deleteError } = await supabase
              .from('parties_joueurs')
              .delete()
              .eq('partie_id', partieId);
              
          if (deleteError) throw deleteError;
          
          // 2. Mise √† jour de la partie de base (nom_jeu, date) dans 'parties'
          const { error: partieUpdateError } = await supabase
              .from('parties')
              .update(partieBase)
              .eq('id', partieId);

          if (partieUpdateError) throw partieUpdateError;
          
          // 3. Insertion des nouvelles lignes dans la table de jointure
          const lignesAInserer = jointureLignes.map(ligne => ({
              ...ligne,
              partie_id: partieId 
          }));

          const { error: jointureError } = await supabase
              .from('parties_joueurs')
              .insert(lignesAInserer);

          if (jointureError) throw jointureError;

          return { success: true };
      } catch (error) {
          console.error("Erreur lors de la modification de la partie:", error);
          alert(`Une erreur est survenue lors de la modification de la partie: ${error.message}`);
          return { success: false, error };
      }
    }

    async function supprimerPartie(id) {
        try {
            // Supprimer d'abord dans parties_joueurs
            await supabase.from('parties_joueurs').delete().eq('partie_id', id);
            
            // Supprimer dans parties
            const { error } = await supabase.from('parties').delete().eq('id', id);
            if (error) throw error;
            return { success: true };
        } catch (error) {
            console.error("Erreur lors de la suppression de la partie:", error);
            alert(`Une erreur est survenue lors de la suppression de la partie: ${error.message}`);
            return { success: false, error };
        }
    }
    
    // --- Fonctions d'aide pour remplir les formulaires ---
    
    function remplirDatalist(datalistElem, optionsArray) {
        datalistElem.innerHTML = '';
        optionsArray.forEach(opt => {
            const value = opt.nom || opt;
            const option = document.createElement('option');
            option.value = value;
            datalistElem.appendChild(option);
        });
    }

    // CHANGEMENT : on stocke l'ID du joueur dans l'attribut data-player-id
    function addPlayerToDiv(joueurNom, joueurId, targetDiv) {
        const existingPlayerIds = [...targetDiv.querySelectorAll('.selected-player')].map(el => el.getAttribute('data-player-id'));
        if (existingPlayerIds.includes(String(joueurId))) return;

        const joueurDiv = document.createElement('div');
        joueurDiv.classList.add('selected-player');
        joueurDiv.setAttribute('data-player-id', joueurId); // Stocker l'ID ici
        joueurDiv.innerHTML = `${joueurNom} <span class="remove-player" data-player-id="${joueurId}">‚úñ</span>`; // Utiliser data-player-id pour le remove
        targetDiv.appendChild(joueurDiv);
    }

    // CHANGEMENT : on r√©cup√®re les IDs des joueurs s√©lectionn√©s
    function getPlayerIdsFromDiv(div) {
        return [...div.querySelectorAll('.selected-player')].map(el => parseInt(el.getAttribute('data-player-id'), 10));
    }

    // Met √† jour la liste des boutons radio pour le vainqueur unique
    function updateSingleVainqueurList(joueursSelectionnesIds, targetDivRadios, namePrefix, currentWinnerId = null) {
        targetDivRadios.innerHTML = '';
        
        if (joueursSelectionnesIds.length === 0) {
            targetDivRadios.innerHTML = '<p>S√©lectionnez au moins un joueur participant pour choisir le vainqueur.</p>';
            return;
        }

        joueursSelectionnesIds.forEach(joueurId => {
            const joueurNom = joueurIdToNom.get(joueurId);
            if (!joueurNom) return; // S√©curit√©
            
            const radioId = `${namePrefix}-vainqueur-${joueurId}`;
            const container = document.createElement('div');
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = `${namePrefix}-vainqueur-radio`;
            radio.value = joueurId; // La valeur est l'ID
            radio.id = radioId;
            if (joueurId === currentWinnerId) {
                radio.checked = true;
            }
            
            const labelRadio = document.createElement('label');
            labelRadio.htmlFor = radioId;
            labelRadio.textContent = joueurNom;
            
            container.appendChild(radio);
            container.appendChild(labelRadio);
            targetDivRadios.appendChild(container);
        });
    }
    
    // üí• CORRECTION: Cette fonction est appel√©e pour toute modification de joueur.
    function updateAllLists(currentEditWinnerId = null) {
      // Formulaire Nouvelle Partie
      const participantsIdsNew = getPlayerIdsFromDiv(joueursParticipationDiv);
      // Met √† jour la liste des radios du formulaire d'ajout
      updateSingleVainqueurList(participantsIdsNew, vainqueursDiv, 'new-partie');
      
      // Formulaire d'√©dition
      const participantsEditionIds = getPlayerIdsFromDiv(editJoueursParticipationDiv);
      
      // R√©cup√®re l'ID du vainqueur actuel
      const currentEditWinner = currentEditWinnerId !== null ? currentEditWinnerId : 
                                document.querySelector('#edit-liste-vainqueurs input[name="edit-partie-vainqueur-radio"]:checked')?.value;
                                
      // Met √† jour la liste des radios du formulaire d'√©dition
      updateSingleVainqueurList(participantsEditionIds, editListeVainqueurs, 'edit-partie', currentEditWinner ? parseInt(currentEditWinner, 10) : null);
    }

    function formatDateToInput(dateString) {
        const date = new Date(dateString);
        // Ajout de l'offset pour afficher la date dans le fuseau horaire local (standard pour datetime-local)
        date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
        return date.toISOString().slice(0, 16);
    }
    
    // --- Fonction principale pour le chargement et l'affichage des donn√©es ---

    async function chargerEtAfficherToutesLesDonnees() {
        console.log("Chargement initial des donn√©es depuis Supabase...");
        jeux = await chargerJeux();
        joueurs = await chargerJoueurs();
        
        // Initialisation des maps ID <-> Nom
        joueurNomToId.clear();
        joueurIdToNom.clear();
        joueurs.forEach(j => {
            joueurNomToId.set(j.nom, j.id);
            joueurIdToNom.set(j.id, j.nom);
        });
        
        parties = await chargerParties(); // Charg√© avec les noms et IDs

        remplirDatalist(jeuxList, jeux);
        remplirDatalist(joueursList, joueurs);
        remplirDatalist(joueursListMultiple, joueurs);
        remplirDatalist(editJeuxList, jeux);
        remplirDatalist(editJoueursList, joueurs);
        remplirDatalist(editJoueursListMultiple, joueurs);

        datePartieInput.value = formatDateToInput(new Date());

        // Initialisation des listes de filtres
        remplirSelect(filtreJeu, jeux, true, 'Tous');
        remplirSelect(filtreJoueur, joueurs, true, 'Tous');
        
        updateAllLists(); // Appel initial apr√®s le chargement des joueurs

        afficherParties();
    }

    // ... (remplirSelect reste inchang√©) ...
    function remplirSelect(selectElem, optionsArray, valeurVide = true, allText = 'Tous') {
      selectElem.innerHTML = '';
      if (valeurVide) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = `${allText} ${selectElem === filtreJeu ? 'les jeux' : 'les joueurs'}`;
        selectElem.appendChild(option);
      }
      optionsArray.forEach(opt => {
        const value = opt.nom || opt;
        const textContent = opt.nom || opt;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = textContent;
        selectElem.appendChild(option);
      });
    }

    // ... (afficherParties reste inchang√©) ...
    function afficherParties() {
      tbodyParties.innerHTML = '';
      const filtreNomJeu = filtreJeu.value;
      const filtreNomJoueur = filtreJoueur.value;
      let partiesFiltrees = parties.filter(p => {
        let matchJeu = filtreNomJeu === '' || p.nom_jeu === filtreNomJeu;
        // p.participants contient maintenant la liste des NOMS
        let matchJoueur = filtreNomJoueur === '' || (p.participants.includes(filtreNomJoueur)); 
        return matchJeu && matchJoueur;
      });
      
      if (partiesFiltrees.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" style="text-align:center; font-style: italic;">Aucune partie trouv√©e correspondant aux filtres.</td>`;
        tbodyParties.appendChild(tr);
        return;
      }
      
      partiesFiltrees.forEach((p) => {
        const tr = document.createElement('tr');
        const date = new Date(p.date);
        
        // p.vainqueurs contient maintenant la liste des NOMS
        const vainqueurs = p.vainqueurs.join(', ') || 'N/A'; 
        const participants = p.participants.join(', ');

        tr.innerHTML = `
          <td>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</td>
          <td>${p.nom_jeu}</td> 
          <td>${participants}</td>
          <td>${vainqueurs}</td>
          <td>
            <button class="btn-modifier" data-partie-id="${p.id}">‚úèÔ∏è</button>
            <button class="btn-supprimer" data-partie-id="${p.id}">üóëÔ∏è</button>
          </td>
        `;
        tbodyParties.appendChild(tr);
      });
    }
    
    // ... (handleWinnerTypeChange reste inchang√©) ...
    function handleWinnerTypeChange(sectionSingle, sectionMultiple, namePrefix) {
      if (document.querySelector(`input[name="${namePrefix}-winner-type"]:checked`).value === 'single') {
        sectionSingle.style.display = 'block';
        sectionMultiple.style.display = 'none';
      } else {
        sectionSingle.style.display = 'none';
        sectionMultiple.style.display = 'block';
      }
    }
    
    singleWinnerRadio.addEventListener('change', () => handleWinnerTypeChange(singleWinnerSection, multipleWinnersSection, 'new'));
    multipleWinnersRadio.addEventListener('change', () => handleWinnerTypeChange(singleWinnerSection, multipleWinnersSection, 'new'));
    editSingleWinnerRadio.addEventListener('change', () => handleWinnerTypeChange(editSingleWinnerSection, editMultipleWinnersSection, 'edit'));
    editMultipleWinnersRadio.addEventListener('change', () => handleWinnerTypeChange(editSingleWinnerSection, editMultipleWinnersSection, 'edit'));

    // --- D√©l√©gation d'√©v√©nements pour le tableau ---
    tbodyParties.addEventListener('click', async (e) => {
      const target = e.target;
      
      if (target.classList.contains('btn-modifier')) {
        const partieId = target.getAttribute('data-partie-id');
        if (partieId) {
          ouvrirEdition(parseInt(partieId, 10));
        }
      } 
      else if (target.classList.contains('btn-supprimer')) {
        const partieId = target.getAttribute('data-partie-id');
        if (partieId) {
          if (confirm("Confirmer la suppression de cette partie ?")) {
            const result = await supprimerPartie(parseInt(partieId, 10));
            if (result.success) {
              alert("Partie supprim√©e !");
              await chargerEtAfficherToutesLesDonnees();
            }
          }
        }
      }
    });
    
    // --- Fonction ouvrirEdition (R√âVIS√âE) ---
    function ouvrirEdition(partieId) {
        const partie = parties.find(p => p.id === partieId);
        if (!partie) return alert("Partie non trouv√©e.");

        // Afficher la section d'√©dition et masquer le formulaire d'ajout
        editionSection.style.display = 'block';
        formPartie.style.display = 'none';
        document.querySelector('h2').textContent = 'Modifier une partie';

        // Remplir les champs de base
        partieIdEditionInput.value = partie.id;
        editJeuInput.value = partie.nom_jeu;
        editDatePartieInput.value = formatDateToInput(partie.date);

        // 1. Joueurs participants (nettoyage et remplissage)
        editJoueursParticipationDiv.innerHTML = '';
        partie.participantIds.forEach(id => {
            addPlayerToDiv(joueurIdToNom.get(id), id, editJoueursParticipationDiv);
        });

        // 2. Vainqueurs (nettoyage et remplissage)
        editVainqueursMultipleDiv.innerHTML = ''; // Nettoyer
        editListeVainqueurs.innerHTML = '';      // Sera rempli par updateAllLists

        if (partie.vainqueurs.length <= 1) {
            editSingleWinnerRadio.checked = true;
            handleWinnerTypeChange(editSingleWinnerSection, editMultipleWinnersSection, 'edit');
            // Mise √† jour de la liste des radios AVEC le vainqueur s√©lectionn√©
            updateAllLists(partie.vainqueurIds[0] || null); 
        } else {
            editMultipleWinnersRadio.checked = true;
            handleWinnerTypeChange(editSingleWinnerSection, editMultipleWinnersSection, 'edit');
            // Remplir la liste des vainqueurs multiples
            partie.vainqueurIds.forEach(id => {
                addPlayerToDiv(joueurIdToNom.get(id), id, editVainqueursMultipleDiv);
            });
            // Mise √† jour pour les joueurs participants (important si un joueur a √©t√© supprim√©)
            updateAllLists();
        }

        // Faire d√©filer vers le haut
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // --- Soumission du formulaire d'√©dition (COMPL√âT√â ET CORRIG√â) ---
    formEdition.addEventListener('submit', async function (e) {
        e.preventDefault();
        const partieId = parseInt(partieIdEditionInput.value, 10);
        const nomJeu = editJeuInput.value;
        const datePartie = editDatePartieInput.value;
        
        const participantsIds = getPlayerIdsFromDiv(editJoueursParticipationDiv);
        
        const winnerType = document.querySelector('input[name="edit-winner-type"]:checked').value;
        let vainqueursIds = [];
        
        if (winnerType === 'single') {
            const vainqueurIdString = document.querySelector('#edit-liste-vainqueurs input[name="edit-partie-vainqueur-radio"]:checked')?.value;
            if (vainqueurIdString) {
                vainqueursIds = [parseInt(vainqueurIdString, 10)];
            }
        } else {
            const vainqueurIdsMultiple = getPlayerIdsFromDiv(editVainqueursMultipleDiv);
            if (vainqueurIdsMultiple.length > 0) {
                vainqueursIds = vainqueurIdsMultiple;
            }
        }

        // Validation de base
        if (!jeux.some(j => j.nom === nomJeu)) {
            alert("Veuillez s√©lectionner un jeu valide.");
            return;
        }
        if (participantsIds.length === 0) {
            alert("Veuillez s√©lectionner au moins un joueur participant.");
            return;
        }
        if (vainqueursIds.length > 0 && !vainqueursIds.every(id => participantsIds.includes(id))) {
             alert("Tous les vainqueurs doivent faire partie des joueurs s√©lectionn√©s.");
             return;
        }
        
        // 1. Pr√©paration de la partie de base
        const partieBase = {
            date: new Date(datePartie).toISOString(),
            nom_jeu: nomJeu,
        };
        
        // 2. Pr√©paration des lignes de jointure (avec le champ est_gagnant)
        const jointureLignes = participantsIds.map(joueurId => ({
            joueur_id: joueurId,
            est_gagnant: vainqueursIds.includes(joueurId) // TRUE si dans la liste des vainqueurs
        }));
        
        const result = await modifierPartie(partieId, partieBase, jointureLignes);
        
        if (result.success) {
            alert("Partie modifi√©e avec succ√®s !");
            editionSection.style.display = 'none';
            formPartie.style.display = 'block';
            document.querySelector('h2').textContent = 'Nouvelle partie';
            await chargerEtAfficherToutesLesDonnees();
        } else {
            console.error('Erreur lors de la modification de la partie:', result.error);
        }
    });

    btnAnnulerEdition.addEventListener('click', () => {
        editionSection.style.display = 'none';
        formPartie.style.display = 'block';
        document.querySelector('h2').textContent = 'Nouvelle partie';
    });
    
    // --- Soumission du formulaire de nouvelle partie (COMPL√âT√â ET CORRIG√â) ---
    formPartie.addEventListener('submit', async function (e) {
      e.preventDefault();
      const nomJeu = jeuInput.value;
      const datePartie = datePartieInput.value;
      
      const participantsIds = getPlayerIdsFromDiv(joueursParticipationDiv);
      
      const winnerType = document.querySelector('input[name="winner-type"]:checked').value;
      let vainqueursIds = [];
      
      if (winnerType === 'single') {
          const vainqueurIdString = document.querySelector('#liste-vainqueurs input[name="new-partie-vainqueur-radio"]:checked')?.value;
          if (vainqueurIdString) {
              vainqueursIds = [parseInt(vainqueurIdString, 10)];
          }
      } else {
          const vainqueurIdsMultiple = getPlayerIdsFromDiv(vainqueursMultipleDiv);
          if (vainqueurIdsMultiple.length > 0) {
              vainqueursIds = vainqueurIdsMultiple;
          }
      }
      
      // Validation
      if (!jeux.some(j => j.nom === nomJeu)) {
          alert("Veuillez s√©lectionner un jeu valide.");
          return;
      }
      if (participantsIds.length === 0) {
          alert("Veuillez s√©lectionner au moins un joueur participant.");
          return;
      }
      if (vainqueursIds.length > 0 && !vainqueursIds.every(id => participantsIds.includes(id))) {
          alert("Tous les vainqueurs doivent faire partie des joueurs s√©lectionn√©s.");
          return;
      }
      
      // 1. Pr√©paration de la partie de base
      const partieBase = {
        date: new Date(datePartie).toISOString(),
        nom_jeu: nomJeu,
      };
      
      // 2. Pr√©paration des lignes de jointure (avec le champ est_gagnant)
      const jointureLignes = participantsIds.map(joueurId => ({
        joueur_id: joueurId,
        est_gagnant: vainqueursIds.includes(joueurId) // TRUE si dans la liste des vainqueurs
      }));
      
      // 3. ENREGISTREMENT (Double insertion)
      const result = await ajouterPartie(partieBase, jointureLignes);
      
      if (result.success) {
          alert("Partie enregistr√©e ! Les statistiques sont √† jour.");
          this.reset();
          datePartieInput.value = formatDateToInput(new Date());
          joueursParticipationDiv.innerHTML = '';
          vainqueursMultipleDiv.innerHTML = ''; // R√©initialise la liste des vainqueurs multiples
          updateAllLists(); // R√©initialise la liste des vainqueurs uniques/radios
          await chargerEtAfficherToutesLesDonnees();
      } else {
          console.error('Erreur lors de l\'enregistrement de la partie:', result.error);
      }
    });


    // --- √âcouteurs pour l'ajout/suppression de joueurs ---
    
    // Ajout d'un joueur participant (formulaire principal)
    joueurInput.addEventListener('input', () => {
        const joueurNom = joueurInput.value;
        const joueurId = joueurNomToId.get(joueurNom);
        if (joueurId) {
            addPlayerToDiv(joueurNom, joueurId, joueursParticipationDiv);
            updateAllLists(); // üí• Met √† jour les radios de vainqueurs
            joueurInput.value = '';
        }
    });
    
    // Ajout d'un joueur participant (formulaire d'√©dition)
    editJoueurInput.addEventListener('input', () => {
        const joueurNom = editJoueurInput.value;
        const joueurId = joueurNomToId.get(joueurNom);
        if (joueurId) {
            addPlayerToDiv(joueurNom, joueurId, editJoueursParticipationDiv);
            updateAllLists(); // üí• Met √† jour les radios de vainqueurs
            editJoueurInput.value = '';
        }
    });

    // Ajout d'un vainqueur ex aequo (formulaire principal)
    vainqueurInput.addEventListener('input', () => {
        const joueurNom = vainqueurInput.value;
        const joueurId = joueurNomToId.get(joueurNom);
        if (joueurId) {
            // V√©rifier que le vainqueur est aussi un participant
            const participantsIds = getPlayerIdsFromDiv(joueursParticipationDiv);
            if (!participantsIds.includes(joueurId)) {
                alert("Le vainqueur doit d'abord √™tre ajout√© comme joueur participant.");
            } else {
                addPlayerToDiv(joueurNom, joueurId, vainqueursMultipleDiv);
            }
            vainqueurInput.value = '';
        }
    });

    // Ajout d'un vainqueur ex aequo (formulaire d'√©dition)
    editVainqueurInput.addEventListener('input', () => {
        const joueurNom = editVainqueurInput.value;
        const joueurId = joueurNomToId.get(joueurNom);
        if (joueurId) {
            // V√©rifier que le vainqueur est aussi un participant
            const participantsIds = getPlayerIdsFromDiv(editJoueursParticipationDiv);
            if (!participantsIds.includes(joueurId)) {
                alert("Le vainqueur doit d'abord √™tre ajout√© comme joueur participant.");
            } else {
                addPlayerToDiv(joueurNom, joueurId, editVainqueursMultipleDiv);
            }
            editVainqueurInput.value = '';
        }
    });

    // √âcouteur de d√©l√©gation pour les boutons de suppression de joueurs
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-player')) {
        const parentDivId = e.target.parentNode.parentNode.id;
        
        // Supprime le joueur du DOM
        e.target.parentNode.remove();
        
        // Si c'√©tait un participant, mettre √† jour la liste des vainqueurs
        if (parentDivId === 'liste-joueurs-participation' || parentDivId === 'edit-liste-joueurs-participation') {
            updateAllLists();
        }
      }
    });
    
    // --- Lancement ---
    chargerEtAfficherToutesLesDonnees();
  </script>
</body>
</html>