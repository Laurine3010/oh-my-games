<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oh My Games - Parties</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Style simple pour la liste des parties */
    #historique-parties {
      margin-top: 30px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
      overflow-x: auto; /* Permet un d√©filement horizontal pour les petits √©crans */
    }
    #historique-parties table {
      width: 100%;
      min-width: 600px; /* Assure une largeur minimale pour la lisibilit√© */
      border-collapse: collapse;
      table-layout: fixed;
    }
    #historique-parties th, #historique-parties td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      word-wrap: break-word;
    }
    #historique-parties th {
      background-color: #f4f4f4;
      font-weight: bold;
    }
    .td-actions {
        width: 120px;
        text-align: center;
    }

    /* Styles du formulaire d'√©dition */
    #edition-partie {
      max-width: 900px;
      margin: 20px auto;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #edition-partie h3 {
      margin-top: 0;
      color: #007bff;
    }
    #edition-partie button {
      cursor: pointer;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    select, input[type="date"], input[type="time"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    /* Styles pour l'ajout multiple de joueurs */
    .players-list-container {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        min-height: 50px;
        margin-top: 10px;
    }
    .player-tag {
        display: inline-flex;
        align-items: center;
        background-color: #e6f7ff;
        color: #007bff;
        padding: 5px 10px;
        border-radius: 15px;
        margin-right: 8px;
        margin-bottom: 8px;
        font-size: 0.9em;
    }
    .remove-player {
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
        color: #721c24;
    }
    
    .autocomplete-list {
        border: 1px solid #ccc;
        max-height: 150px;
        overflow-y: auto;
        position: absolute;
        z-index: 10;
        width: 98%;
        background-color: white;
    }
    .autocomplete-item {
        padding: 8px;
        cursor: pointer;
    }
    .autocomplete-item:hover {
        background-color: #f0f0f0;
    }
  </style>
</head>

<body>
  <div id="group-info" style="text-align: right; margin-top: 10px; margin-right: 10px;">
    <span id="current-group-alias"></span>
    <button onclick="location.href='groupes.html'" class="btn-home" style="position: static; margin-left: 10px; padding: 5px 10px;">Changer de groupe</button>
  </div>
  <h1>Oh My Games</h1>
  <h2>Historique des Parties</h2>
  <img src="omg_img.png" alt="Fond" class="background-image" />

  <button id="btn-ajouter-partie" class="btn-add">‚ûï Ajouter une partie</button>
  <button class="btn-home" onclick="location.href='roue.html'">üé≤ Roue des jeux</button>

  <div id="edition-partie">
    <button id="btn-fermer" class="close-button">&times;</button>
    <h3 id="form-title">Ajouter une nouvelle partie</h3>
    <form id="form-ajout">
      <input type="hidden" id="partie-id" />

      <div class="form-group">
        <label for="jeu-id">Jeu jou√© :</label>
        <select id="jeu-id" required></select>
      </div>

      <div class="form-group">
        <label for="date-partie">Date :</label>
        <input type="date" id="date-partie" required />
      </div>

      <div class="form-group">
        <label for="heure-partie">Heure (optionnel) :</label>
        <input type="time" id="heure-partie" />
      </div>

      <hr />

      <div class="form-group">
        <label for="joueur-participation">Ajouter un participant :</label>
        <input type="text" id="joueur-participation" placeholder="Nom du joueur" list="joueurs-datalist" />
        <div id="liste-joueurs-participation" class="players-list-container" data-list-type="participants"></div>
      </div>

      <div class="form-group">
        <label for="vainqueur-multiple">Ajouter un vainqueur (ex aequo) :</label>
        <input type="text" id="vainqueur-multiple" placeholder="Nom du joueur participant" list="joueurs-datalist" />
        <div id="liste-vainqueurs-multiple" class="players-list-container" data-list-type="vainqueurs"></div>
        <small>Les vainqueurs doivent faire partie des participants.</small>
      </div>
      
      <datalist id="joueurs-datalist"></datalist>

      <button type="submit" id="btn-submit" class="btn-add">Enregistrer la partie</button>
      <button type="button" id="btn-annuler" class="btn-supprimer">Annuler</button>
    </form>
  </div>

  <div id="historique-parties">
    <table>
      <thead>
        <tr>
          <th>Jeu</th>
          <th>Date</th>
          <th>Participants</th>
          <th>Gagnant(s)</th>
          <th class="td-actions">Actions</th>
        </tr>
      </thead>
      <tbody id="liste-parties">
        <tr><td colspan="5" style="text-align: center;">Chargement de l'historique...</td></tr>
      </tbody>
    </table>
  </div>
  
  <button class="btn-home" onclick="location.href='home.html'">üè† Home</button>

  <script type="module">
    import { supabase } from './supabase-config.js';
    
    // --- Variables Globales ---
    let joueursMap = new Map(); // Map pour ID -> Nom du joueur
    let joueurNomToId = new Map(); // Map pour Nom -> ID du joueur
    let parties = []; // Cache des parties
    let selectedGroupId = null;

    // --- R√©f√©rences DOM ---
    const groupeAliasSpan = document.getElementById('current-group-alias');
    const editionPartieDiv = document.getElementById('edition-partie');
    const formAjout = document.getElementById('form-ajout');
    const formTitle = document.getElementById('form-title');
    const btnAjouterPartie = document.getElementById('btn-ajouter-partie');
    const btnFermer = document.getElementById('btn-fermer');
    const btnAnnuler = document.getElementById('btn-annuler');
    const partieIdInput = document.getElementById('partie-id');
    const jeuIdSelect = document.getElementById('jeu-id');
    const datePartieInput = document.getElementById('date-partie');
    const heurePartieInput = document.getElementById('heure-partie');
    const joueursDatalist = document.getElementById('joueurs-datalist');
    const joueurParticipationInput = document.getElementById('joueur-participation');
    const vainqueurMultipleInput = document.getElementById('vainqueur-multiple');
    const joueursParticipationDiv = document.getElementById('liste-joueurs-participation');
    const vainqueursMultipleDiv = document.getElementById('liste-vainqueurs-multiple');
    const listePartiesBody = document.getElementById('liste-parties');

    // --- Fonctions Utilitaires ---

    /**
     * V√©rifie l'authentification et le groupe s√©lectionn√©.
     * @returns {boolean} Vrai si la session est active et un groupe est s√©lectionn√©.
     */
    async function checkAuthAndGroup() {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error || !session) {
            alert("Veuillez vous connecter pour acc√©der √† l'historique des parties.");
            location.href = 'index.html'; // Redirection vers la page de connexion/inscription
            return false;
        }

        selectedGroupId = localStorage.getItem('selected_group_id');
        const currentGroupAlias = localStorage.getItem('selected_group_alias');
        
        if (!selectedGroupId) {
            alert("Veuillez s√©lectionner un groupe.");
            location.href = 'groupes.html'; // Redirection vers la page de s√©lection de groupe
            return false;
        }

        groupeAliasSpan.textContent = `Groupe : ${currentGroupAlias}`;
        return true;
    }

    /**
     * R√©initialise le formulaire d'ajout/√©dition.
     */
    function resetForm() {
        formAjout.reset();
        partieIdInput.value = '';
        joueursParticipationDiv.innerHTML = '';
        vainqueursMultipleDiv.innerHTML = '';
        formTitle.textContent = 'Ajouter une nouvelle partie';
        document.getElementById('btn-submit').textContent = 'Enregistrer la partie';
    }

    /**
     * Ajoute un joueur (tag) √† une liste de joueurs (participants ou vainqueurs).
     * @param {string} nom Nom du joueur.
     * @param {string} id ID UUID du joueur.
     * @param {HTMLElement} targetDiv √âl√©ment DIV o√π ajouter le tag.
     */
    function addPlayerToDiv(nom, id, targetDiv) {
        // Emp√™cher les doublons
        const existingTags = targetDiv.querySelectorAll('.player-tag');
        for (const tag of existingTags) {
            if (tag.dataset.id === id) {
                return; // Doublon trouv√©
            }
        }

        const tag = document.createElement('span');
        tag.classList.add('player-tag');
        tag.dataset.id = id;
        tag.textContent = nom;
        tag.innerHTML += ` <span class="remove-player" data-id="${id}">&times;</span>`;
        targetDiv.appendChild(tag);
    }

    /**
     * R√©cup√®re la liste des IDs de joueurs √† partir d'un √©l√©ment DIV.
     * @param {HTMLElement} sourceDiv √âl√©ment DIV contenant les tags de joueurs.
     * @returns {string[]} Tableau des IDs UUID.
     */
    function getPlayerIdsFromDiv(sourceDiv) {
        return Array.from(sourceDiv.querySelectorAll('.player-tag')).map(tag => tag.dataset.id);
    }

    /**
     * Met √† jour la liste des vainqueurs pour s'assurer qu'ils sont toujours dans la liste des participants.
     */
    function updateAllLists() {
        const participantsIds = getPlayerIdsFromDiv(joueursParticipationDiv);
        const vainqueursIds = getPlayerIdsFromDiv(vainqueursMultipleDiv);
        
        // Vainqueurs: on supprime ceux qui ne sont plus dans les participants
        const newVainqueurs = vainqueursIds.filter(id => participantsIds.includes(id));
        
        // Reconstruire la liste des vainqueurs
        vainqueursMultipleDiv.innerHTML = '';
        newVainqueurs.forEach(id => {
            addPlayerToDiv(joueursMap.get(id), id, vainqueursMultipleDiv);
        });
    }


    // --- Logique de Chargement des Donn√©es ---

    /**
     * Charge les listes de jeux et de joueurs pour les s√©lecteurs du formulaire.
     */
    async function chargerTousLesJoueursEtJeux() {
        if (!selectedGroupId) return;
        
        // 1. Charger les joueurs
        const { data: joueursData, error: joueursError } = await supabase
            .from('omg_app.joueurs') // <-- CORRIG√â : Utilisation du sch√©ma omg_app
            .select('id, nom')
            .eq('groupe_id', selectedGroupId)
            .order('nom', { ascending: true });

        if (joueursError) {
            console.error("Erreur lors du chargement des joueurs:", joueursError);
            return;
        }

        joueursMap.clear();
        joueurNomToId.clear();
        joueursDatalist.innerHTML = '';

        joueursData.forEach(j => {
            joueursMap.set(j.id, j.nom);
            joueurNomToId.set(j.nom, j.id);
            const option = document.createElement('option');
            option.value = j.nom;
            joueursDatalist.appendChild(option);
        });

        // 2. Charger les jeux
        jeuIdSelect.innerHTML = '<option value="">-- Choisir un jeu --</option>';
        const { data: jeuxData, error: jeuxError } = await supabase
            .from('omg_app.jeux') // <-- CORRIG√â : Utilisation du sch√©ma omg_app
            .select('id, nom')
            .eq('groupe_id', selectedGroupId)
            .order('nom', { ascending: true });
        
        if (jeuxError) {
            console.error("Erreur lors du chargement des jeux:", jeuxError);
            return;
        }

        jeuxData.forEach(jeu => {
            const option = document.createElement('option');
            option.value = jeu.id;
            option.textContent = jeu.nom;
            jeuIdSelect.appendChild(option);
        });
    }

    /**
     * Charge et affiche la liste de toutes les parties.
     */
    async function chargerEtAfficherParties() {
        if (!selectedGroupId) return;
        
        listePartiesBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Chargement...</td></tr>';

        // Requ√™te SELECT complexe avec jointures
        const { data, error } = await supabase
            .from('omg_app.parties') // <-- CORRIG√â : Utilisation du sch√©ma omg_app
            .select(`
                id,
                date,
                jeu:jeu_id(nom),
                gagnant_id,
                joueurs_ids
            `)
            .eq('groupe_id', selectedGroupId)
            .order('date', { ascending: false });

        if (error) {
            console.error("Erreur de chargement des parties:", error);
            listePartiesBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">Erreur de chargement : ${error.message}</td></tr>`;
            return;
        }

        parties = data;
        afficherParties(data);
    }

    /**
     * Affiche les parties dans le tableau HTML.
     * @param {Array} partiesData Tableau des donn√©es de partie.
     */
    function afficherParties(partiesData) {
        listePartiesBody.innerHTML = '';

        if (partiesData.length === 0) {
            listePartiesBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Aucune partie enregistr√©e.</td></tr>';
            return;
        }

        partiesData.forEach(partie => {
            const row = listePartiesBody.insertRow();
            
            // Formatage de la date
            const dateObj = new Date(partie.date);
            const dateStr = dateObj.toLocaleDateString('fr-FR', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            }).replace(',', ' √†');
            
            // Noms des participants (r√©cup√©ration des noms √† partir des IDs stock√©s dans le tableau joueurs_ids)
            const participantsNoms = (partie.joueurs_ids || [])
                .map(id => joueursMap.get(id))
                .filter(Boolean) // Retire les IDs qui ne correspondent plus √† un joueur existant
                .join(', ');

            // Nom du gagnant (r√©cup√©ration des noms √† partir du tableau gagnant_id)
            const gagnantsNoms = (partie.gagnant_id || [])
                .map(id => joueursMap.get(id))
                .filter(Boolean)
                .join(', ');
                
            row.insertCell().textContent = partie.jeu ? partie.jeu.nom : 'Jeu Inconnu';
            row.insertCell().textContent = dateStr;
            row.insertCell().textContent = participantsNoms || 'Inconnu';
            row.insertCell().innerHTML = gagnantsNoms ? `<strong>${gagnantsNoms}</strong>` : 'Aucun';
            
            const actionCell = row.insertCell();
            actionCell.classList.add('td-actions');
            actionCell.innerHTML = `
                <button onclick="window.ouvrirModaleEdition('${partie.id}')">‚úèÔ∏è</button>
                <button onclick="window.supprimerPartie('${partie.id}')">üóëÔ∏è</button>
            `;
        });
    }

    /**
     * Fonction principale de chargement
     */
    async function chargerEtAfficherToutesLesDonnees() {
        if (await checkAuthAndGroup()) {
            await chargerTousLesJoueursEtJeux();
            await chargerEtAfficherParties();
        }
    }

    // --- Logique des Formulaires ---

    // Soumission du formulaire (Ajout ou Modification)
    formAjout.addEventListener('submit', async (e) => {
        e.preventDefault();

        const partieId = partieIdInput.value;
        const jeuId = jeuIdSelect.value;
        const datePartie = datePartieInput.value;
        const heurePartie = heurePartieInput.value;
        const joueursIds = getPlayerIdsFromDiv(joueursParticipationDiv);
        const gagnantsIds = getPlayerIdsFromDiv(vainqueursMultipleDiv);

        if (!jeuId || !datePartie || joueursIds.length === 0) {
            alert("Veuillez remplir le jeu, la date et ajouter au moins un participant.");
            return;
        }

        let datetimeStr = datePartie;
        if (heurePartie) {
            datetimeStr += `T${heurePartie}:00`;
        } else {
             // Supabase exige le format ISO 8601 pour TIMESTAMP WITH TIME ZONE
            datetimeStr += `T00:00:00`;
        }

        const partieData = {
            jeu_id: jeuId,
            date: datetimeStr,
            joueurs_ids: joueursIds,
            gagnant_id: gagnantsIds, // Colonne maintenant un tableau d'UUIDs
            groupe_id: selectedGroupId // Ajout√© explicitement dans le cas d'un INSERT
        };

        let error;

        if (partieId) {
            // Requ√™te UPDATE
            const res = await supabase
                .from('omg_app.parties') // <-- CORRIG√â : Utilisation du sch√©ma omg_app
                .update(partieData)
                .eq('id', partieId);
            error = res.error;
            
        } else {
            // Requ√™te INSERT
            const res = await supabase
                .from('omg_app.parties') // <-- CORRIG√â : Utilisation du sch√©ma omg_app
                .insert([partieData]);
            error = res.error;
        }

        if (error) {
            console.error("Erreur lors de l'enregistrement de la partie:", error);
            alert(`Erreur lors de l'enregistrement de la partie: ${error.message}`);
        } else {
            resetForm();
            editionPartieDiv.style.display = 'none';
            await chargerEtAfficherParties();
        }
    });

    /**
     * Ouvre la modale pour l'√©dition d'une partie existante.
     * @param {string} id ID UUID de la partie √† √©diter.
     */
    window.ouvrirModaleEdition = function (id) {
        resetForm();
        const partie = parties.find(p => p.id === id);
        
        if (!partie) {
            alert("Partie non trouv√©e.");
            return;
        }

        // 1. Remplir les champs simples
        partieIdInput.value = partie.id;
        jeuIdSelect.value = partie.jeu_id;
        
        const dateObj = new Date(partie.date);
        
        // Formatage de la date (AAAA-MM-JJ)
        datePartieInput.value = dateObj.toISOString().split('T')[0];
        
        // Formatage de l'heure (HH:MM)
        const hour = dateObj.getHours().toString().padStart(2, '0');
        const minute = dateObj.getMinutes().toString().padStart(2, '0');
        heurePartieInput.value = `${hour}:${minute}`;

        // 2. Remplir les joueurs participants
        partie.joueurs_ids.forEach(id => {
            const nom = joueursMap.get(id);
            if (nom) addPlayerToDiv(nom, id, joueursParticipationDiv);
        });

        // 3. Remplir les vainqueurs
        (partie.gagnant_id || []).forEach(id => {
            const nom = joueursMap.get(id);
            if (nom) addPlayerToDiv(nom, id, vainqueursMultipleDiv);
        });

        formTitle.textContent = 'Modifier la partie';
        document.getElementById('btn-submit').textContent = 'Sauvegarder les modifications';
        editionPartieDiv.style.display = 'flex';
    };

    /**
     * Supprime une partie.
     * @param {string} id ID UUID de la partie √† supprimer.
     */
    window.supprimerPartie = async function (id) {
        if (confirm("√ätes-vous s√ªr de vouloir supprimer cette partie ? Cette action est irr√©versible.")) {
            const { error } = await supabase
                .from('omg_app.parties') // <-- CORRIG√â : Utilisation du sch√©ma omg_app
                .delete()
                .eq('id', id);

            if (error) {
                console.error("Erreur lors de la suppression:", error);
                alert(`Erreur lors de la suppression de la partie: ${error.message}`);
            } else {
                await chargerEtAfficherParties();
            }
        }
    };

    // --- Listeners d'√âv√©nements ---

    btnAjouterPartie.addEventListener('click', () => {
        resetForm();
        editionPartieDiv.style.display = 'flex';
    });

    btnFermer.addEventListener('click', () => {
        editionPartieDiv.style.display = 'none';
        resetForm();
    });

    btnAnnuler.addEventListener('click', () => {
        editionPartieDiv.style.display = 'none';
        resetForm();
    });

    // Ajout d'un participant
    joueurParticipationInput.addEventListener('change', () => {
        const joueurNom = joueurParticipationInput.value.trim();
        const joueurId = joueurNomToId.get(joueurNom);
        if (joueurId) {
            addPlayerToDiv(joueurNom, joueurId, joueursParticipationDiv);
            updateAllLists(); // V√©rifier si un vainqueur a √©t√© supprim√©
        }
        joueurParticipationInput.value = '';
    });

    // Ajout d'un vainqueur
    vainqueurMultipleInput.addEventListener('change', () => {
        const joueurNom = vainqueurMultipleInput.value.trim();
        const joueurId = joueurNomToId.get(joueurNom);
        if (joueurId) {
            // V√©rifier que le vainqueur est aussi un participant
            const participantsIds = getPlayerIdsFromDiv(joueursParticipationDiv);
            if (!participantsIds.includes(joueurId)) {
                alert("Le vainqueur doit d'abord √™tre ajout√© comme joueur participant.");
            } else {
                addPlayerToDiv(joueurNom, joueurId, vainqueursMultipleDiv);
            }
        }
        vainqueurMultipleInput.value = '';
    });

    // √âcouteur de d√©l√©gation pour les boutons de suppression de joueurs/vainqueurs
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-player')) {
        const parentDivId = e.target.parentNode.parentNode.id;
        
        // Supprime le joueur du DOM
        e.target.parentNode.remove();
        
        // Si c'√©tait un participant, mettre √† jour la liste des vainqueurs
        if (parentDivId === 'liste-joueurs-participation') {
            updateAllLists();
        }
      }
    });
    
    // --- Lancement ---
    document.addEventListener('DOMContentLoaded', chargerEtAfficherToutesLesDonnees);
    
    // Recharger les donn√©es quand la page redevient visible
    document.addEventListener('visibilitychange', async () => { 
        if (document.visibilityState === 'visible') { 
            await chargerEtAfficherToutesLesDonnees(); 
        } 
    });

  </script>
</body>
</html>