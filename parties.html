<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oh My Games - Parties</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Styles pour la liste des parties */
    #historique-parties {
      margin-top: 30px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
    }
    #historique-parties table {
      width: 100%;
      border-collapse: collapse;
    }
    #historique-parties th, #historique-parties td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #historique-parties th {
      background-color: #f4f4f4;
    }

    /* Styles pour le formulaire d'édition */
    #edition-partie {
      max-width: 900px;
      margin: 20px auto;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #edition-partie h3 {
      margin-top: 0;
    }
    #edition-partie button {
      cursor: pointer;
    }

    /* Styles pour les champs de recherche avec suggestions */
    .autocomplete-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .autocomplete-input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .autocomplete-list {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
    }
    .autocomplete-list-item {
      padding: 10px;
      cursor: pointer;
      background-color: #fff;
      border-bottom: 1px solid #d4d4d4;
    }
    .autocomplete-list-item:hover {
      background-color: #e9e9e9;
    }
    .selected-items {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f4f4f4;
    }
    .selected-item {
      display: inline-block;
      margin: 5px;
      padding: 5px 10px;
      background-color: #007BFF;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
    .selected-item .remove-btn {
      margin-left: 5px;
      color: #fff;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Oh My Games</h1>
  <h2>Nouvelle partie</h2>

  <img src="img_jeux.png" alt="Fond" class="background-image" />
  <button class="btn-home" onclick="location.href='index.html'">&#127968; Home</button>

  <form id="form-partie">
    <label for="jeu-input">Jeu :</label><br />
    <div class="autocomplete-container">
      <input type="text" id="jeu-input" class="autocomplete-input" placeholder="Rechercher un jeu..." required>
      <div id="jeu-suggestions" class="autocomplete-list"></div>
      <input type="hidden" id="jeu-id">
    </div><br /><br />

    <label for="date-partie">Date de la partie :</label><br />
    <input type="datetime-local" id="date-partie" name="date-partie" required><br /><br />

    <label for="joueurs-input">Joueurs participants :</label><br />
    <div class="autocomplete-container">
      <input type="text" id="joueurs-input" class="autocomplete-input" placeholder="Ajouter des joueurs...">
      <div id="joueurs-suggestions" class="autocomplete-list"></div>
    </div>
    <div id="selected-joueurs" class="selected-items"></div><br />

    <label for="vainqueur-input">Vainqueur :</label><br />
    <div class="autocomplete-container">
      <input type="text" id="vainqueur-input" class="autocomplete-input" placeholder="Rechercher le vainqueur...">
      <div id="vainqueur-suggestions" class="autocomplete-list"></div>
      <input type="hidden" id="vainqueur-nom">
    </div><br />

    <button type="submit">Enregistrer la partie</button>
  </form>

  <section id="historique-parties">
    <h2>Historique des parties jouées</h2>

    <label for="filtre-jeu">Filtrer par jeu :</label>
    <select id="filtre-jeu">
      <option value="">Tous les jeux</option>
    </select>

    <label for="filtre-joueur" style="margin-left: 20px;">Filtrer par joueur :</label>
    <select id="filtre-joueur">
      <option value="">Tous les joueurs</option>
    </select>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Jeu</th>
          <th>Joueurs</th>
          <th>Vainqueur</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="table-body-parties"></tbody>
    </table>
  </section>

  <section id="edition-partie">
    <h3>Modifier la partie</h3>
    <form id="form-edition">
      <input type="hidden" id="partie-id-edition">

      <label for="edit-jeu-input">Jeu :</label><br />
      <div class="autocomplete-container">
        <input type="text" id="edit-jeu-input" class="autocomplete-input" placeholder="Rechercher un jeu..." required>
        <div id="edit-jeu-suggestions" class="autocomplete-list"></div>
        <input type="hidden" id="edit-jeu-id">
      </div><br /><br />
      
      <label for="edit-date-partie">Date de la partie :</label><br />
      <input type="datetime-local" id="edit-date-partie" name="edit-date-partie" required><br /><br />

      <label for="edit-joueurs-input">Joueurs participants :</label><br />
      <div class="autocomplete-container">
        <input type="text" id="edit-joueurs-input" class="autocomplete-input" placeholder="Ajouter des joueurs...">
        <div id="edit-joueurs-suggestions" class="autocomplete-list"></div>
      </div>
      <div id="edit-selected-joueurs" class="selected-items"></div><br />

      <label for="edit-vainqueur-input">Vainqueur :</label><br />
      <div class="autocomplete-container">
        <input type="text" id="edit-vainqueur-input" class="autocomplete-input" placeholder="Rechercher le vainqueur...">
        <div id="edit-vainqueur-suggestions" class="autocomplete-list"></div>
        <input type="hidden" id="edit-vainqueur-nom">
      </div><br />

      <button type="submit">Sauvegarder les modifications</button>
      <button type="button" id="btn-annuler-edition" style="margin-left:10px;">Annuler</button>
    </form>
  </section>

  <script type="module">
    console.log("Script parties.html chargé.");

    import { supabase } from './supabase-config.js';

    let joueurs = [];
    let jeux = [];
    let parties = [];

    // DOM References - New Party Form
    const jeuInput = document.getElementById('jeu-input');
    const jeuSuggestions = document.getElementById('jeu-suggestions');
    const datePartieInput = document.getElementById('date-partie');
    const joueursInput = document.getElementById('joueurs-input');
    const joueursSuggestions = document.getElementById('joueurs-suggestions');
    const selectedJoueursDiv = document.getElementById('selected-joueurs');
    const vainqueurInput = document.getElementById('vainqueur-input');
    const vainqueurSuggestions = document.getElementById('vainqueur-suggestions');
    const formPartie = document.getElementById('form-partie');

    // DOM References - Filters & Table
    const filtreJeu = document.getElementById('filtre-jeu');
    const filtreJoueur = document.getElementById('filtre-joueur');
    const tbodyParties = document.getElementById('table-body-parties');

    // DOM References - Edit Form
    const editionSection = document.getElementById('edition-partie');
    const formEdition = document.getElementById('form-edition');
    const partieIdEditionInput = document.getElementById('partie-id-edition');
    const editJeuInput = document.getElementById('edit-jeu-input');
    const editJeuSuggestions = document.getElementById('edit-jeu-suggestions');
    const editDatePartieInput = document.getElementById('edit-date-partie');
    const editJoueursInput = document.getElementById('edit-joueurs-input');
    const editJoueursSuggestions = document.getElementById('edit-joueurs-suggestions');
    const editSelectedJoueursDiv = document.getElementById('edit-selected-joueurs');
    const editVainqueurInput = document.getElementById('edit-vainqueur-input');
    const editVainqueurSuggestions = document.getElementById('edit-vainqueur-suggestions');
    const btnAnnulerEdition = document.getElementById('btn-annuler-edition');

    // --- Fonctions de communication avec Supabase ---
    async function chargerJeux() {
        try {
            const { data, error } = await supabase.from('jeux').select('id, nom');
            if (error) throw error;
            return data;
        } catch (error) {
            console.error("Erreur lors du chargement des jeux:", error);
            return [];
        }
    }

    async function chargerJoueurs() {
        try {
            const { data, error } = await supabase.from('joueurs').select('id, nom');
            if (error) throw error;
            return data;
        } catch (error) {
            console.error("Erreur lors du chargement des joueurs:", error);
            return [];
        }
    }

    async function chargerParties() {
        try {
            const { data, error } = await supabase.from('parties').select('*');
            if (error) throw error;
            return data;
        } catch (error) {
            console.error("Erreur lors du chargement des parties:", error);
            return [];
        }
    }

    async function ajouterPartie(partieData) {
      try {
          const { data, error } = await supabase.from('parties').insert(partieData).select();
          if (error) throw error;
          return { success: true, data: data[0] };
      } catch (error) {
          console.error("Erreur lors de l'enregistrement de la partie:", error);
          alert(`Une erreur est survenue lors de l'enregistrement de la partie: ${error.message}`);
          return { success: false, error };
      }
    }

    async function modifierPartie(id, partieData) {
      try {
          const { data, error } = await supabase.from('parties').update(partieData).eq('id', id).select();
          if (error) throw error;
          return { success: true, data: data[0] };
      } catch (error) {
          console.error("Erreur lors de la modification de la partie:", error);
          alert(`Une erreur est survenue lors de la modification de la partie: ${error.message}`);
          return { success: false, error };
      }
    }

    async function supprimerPartie(id) {
      try {
          const { error } = await supabase.from('parties').delete().eq('id', id);
          if (error) throw error;
          return { success: true };
      } catch (error) {
          console.error("Erreur lors de la suppression de la partie:", error);
          alert(`Une erreur est survenue lors de la suppression de la partie: ${error.message}`);
          return { success: false, error };
      }
    }
    
    // --- Fonctions d'aide pour les champs de recherche ---
    function setupAutocomplete(inputElement, suggestionsElement, sourceArray, onSelect, selectedItemsContainer = null) {
      inputElement.addEventListener('input', () => {
        const value = inputElement.value.toLowerCase();
        suggestionsElement.innerHTML = '';
        if (value.length === 0) {
          return;
        }
        
        const filteredList = sourceArray.filter(item => {
          const itemName = item.nom ? item.nom.toLowerCase() : item.toLowerCase();
          return itemName.includes(value);
        });

        filteredList.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.classList.add('autocomplete-list-item');
          itemElement.textContent = item.nom || item;
          itemElement.dataset.id = item.id;
          itemElement.addEventListener('click', () => {
            onSelect(item);
            inputElement.value = '';
            suggestionsElement.innerHTML = '';
          });
          suggestionsElement.appendChild(itemElement);
        });
      });

      document.addEventListener('click', (e) => {
        if (!inputElement.contains(e.target) && !suggestionsElement.contains(e.target)) {
          suggestionsElement.innerHTML = '';
        }
      });
    }

    function addSelectedItem(item, container, inputElement) {
      const selectedItem = document.createElement('span');
      selectedItem.classList.add('selected-item');
      selectedItem.textContent = item.nom;
      selectedItem.dataset.id = item.id;
      selectedItem.dataset.nom = item.nom;

      const removeBtn = document.createElement('span');
      removeBtn.classList.add('remove-btn');
      removeBtn.innerHTML = '&times;';
      removeBtn.addEventListener('click', () => {
        selectedItem.remove();
        updateVainqueursList(getParticipants(inputElement));
      });
      selectedItem.appendChild(removeBtn);
      container.appendChild(selectedItem);
      updateVainqueursList(getParticipants(inputElement));
    }

    function getParticipants(inputElement) {
      const container = inputElement === joueursInput ? selectedJoueursDiv : editSelectedJoueursDiv;
      const participants = [...container.querySelectorAll('.selected-item')].map(item => item.dataset.nom);
      return participants;
    }

    function updateVainqueursList(joueursParticipants) {
        // Sélectionne les champs de vainqueur appropriés
        const currentVainqueurInput = formEdition.style.display === 'block' ? editVainqueurInput : vainqueurInput;
        const currentVainqueurSuggestions = formEdition.style.display === 'block' ? editVainqueurSuggestions : vainqueurSuggestions;
        const currentVainqueurNom = formEdition.style.display === 'block' ? document.getElementById('edit-vainqueur-nom') : document.getElementById('vainqueur-nom');

        const currentVainqueur = currentVainqueurNom.value;

        setupAutocomplete(currentVainqueurInput, currentVainqueurSuggestions, joueursParticipants, (vainqueurNom) => {
            currentVainqueurInput.value = vainqueurNom;
            currentVainqueurNom.value = vainqueurNom;
        });

        // Clear the input and suggestions if the current winner is no longer in the list
        if (currentVainqueur && !joueursParticipants.includes(currentVainqueur)) {
            currentVainqueurInput.value = '';
            currentVainqueurNom.value = '';
        } else if (currentVainqueur) {
            currentVainqueurInput.value = currentVainqueur;
        }
    }

    function remplirSelect(selectElem, optionsArray, valeurVide = true, allText = 'Tous') {
      selectElem.innerHTML = '';
      if (valeurVide) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = `${allText} ${selectElem === filtreJeu ? 'les jeux' : 'les joueurs'}`;
        selectElem.appendChild(option);
      }
      optionsArray.forEach(opt => {
        const value = opt.nom || opt;
        const textContent = opt.nom || opt;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = textContent;
        selectElem.appendChild(option);
      });
    }

    function formatDateToInput(dateString) {
      const date = new Date(dateString);
      date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
      return date.toISOString().slice(0, 16);
    }
    
    // --- Fonction principale pour le chargement et l'affichage des données ---
    async function chargerEtAfficherToutesLesDonnees() {
        console.log("Chargement initial des données depuis Supabase...");
        jeux = await chargerJeux();
        joueurs = await chargerJoueurs();
        parties = await chargerParties();

        remplirSelect(filtreJeu, jeux, true, 'Tous');
        remplirSelect(filtreJoueur, joueurs, true, 'Tous');
        
        datePartieInput.value = formatDateToInput(new Date());

        // Setup autocompletes
        setupAutocomplete(jeuInput, jeuSuggestions, jeux, (jeu) => {
          jeuInput.value = jeu.nom;
        });
        setupAutocomplete(joueursInput, joueursSuggestions, joueurs, (joueur) => {
          addSelectedItem(joueur, selectedJoueursDiv, joueursInput);
        });

        afficherParties();
    }

    // --- Affichage de l'historique des parties ---
    function afficherParties() {
      tbodyParties.innerHTML = '';
      const filtreNomJeu = filtreJeu.value;
      const filtreNomJoueur = filtreJoueur.value;
      let partiesFiltrees = parties.filter(p => {
        let matchJeu = filtreNomJeu === '' || p.nom_jeu === filtreNomJeu;
        let matchJoueur = filtreNomJoueur === '' || (Array.isArray(p.joueurs) && p.joueurs.includes(filtreNomJoueur));
        return matchJeu && matchJoueur;
      });
      partiesFiltrees.sort((a, b) => new Date(b.date) - new Date(a.date));
      if (partiesFiltrees.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" style="text-align:center; font-style: italic;">Aucune partie trouvée correspondant aux filtres.</td>`;
        tbodyParties.appendChild(tr);
        return;
      }
      partiesFiltrees.forEach((p) => {
        const tr = document.createElement('tr');
        const date = new Date(p.date);
        tr.innerHTML = `
          <td>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</td>
          <td>${p.nom_jeu}</td> 
          <td>${Array.isArray(p.joueurs) ? p.joueurs.join(', ') : ''}</td>
          <td>${p.gagnant || 'N/A'}</td>
          <td>
            <button class="btn-modifier" data-partie-id="${p.id}">✏️</button>
            <button class="btn-supprimer" data-partie-id="${p.id}">🗑️</button>
          </td>
        `;
        tbodyParties.appendChild(tr);
      });
    }

    // --- Listeners pour les filtres ---
    filtreJeu.addEventListener('change', afficherParties);
    filtreJoueur.addEventListener('change', afficherParties);

    // --- Soumission du formulaire de nouvelle partie ---
    formPartie.addEventListener('submit', async function (e) {
      e.preventDefault();
      const nomJeu = jeuInput.value;
      const datePartie = datePartieInput.value;
      const joueursPartie = getParticipants(joueursInput);
      const vainqueur = vainqueurInput.value;
      
      if (!nomJeu) {
          alert("Veuillez sélectionner un jeu.");
          return;
      }
      if (joueursPartie.length === 0) {
          alert("Veuillez sélectionner au moins un joueur participant.");
          return;
      }
      if (!vainqueur || !joueursPartie.includes(vainqueur)) {
        alert("Le vainqueur doit faire partie des joueurs sélectionnés.");
        return;
      }
      
      const nouvellePartie = {
        date: new Date(datePartie).toISOString(),
        nom_jeu: nomJeu,
        joueurs: joueursPartie,
        gagnant: vainqueur,
      };
      
      const result = await ajouterPartie(nouvellePartie);
      if (result.success) {
          alert("Partie enregistrée !");
          this.reset();
          selectedJoueursDiv.innerHTML = '';
          updateVainqueursList([]);
          datePartieInput.value = formatDateToInput(new Date());
          await chargerEtAfficherToutesLesDonnees();
      } else {
          console.error('Erreur lors de l\'enregistrement de la partie:', result.error);
      }
    });

    // --- Délégation d'événements pour le tableau ---
    tbodyParties.addEventListener('click', async (e) => {
      const target = e.target;
      
      if (target.classList.contains('btn-modifier')) {
        const partieId = target.getAttribute('data-partie-id');
        if (partieId) {
          ouvrirEdition(partieId);
        }
      } 
      else if (target.classList.contains('btn-supprimer')) {
        const partieId = target.getAttribute('data-partie-id');
        if (partieId) {
          if (confirm("Confirmer la suppression de cette partie ?")) {
            const result = await supprimerPartie(partieId);
            if (result.success) {
              alert("Partie supprimée !");
              await chargerEtAfficherToutesLesDonnees();
            } else {
              console.error("Erreur lors de la suppression de la partie:", result.error);
            }
          }
        }
      }
    });

    // --- Logique du formulaire d'édition ---
    function ouvrirEdition(partieId) {
      const partie = parties.find(p => p.id === partieId);
      if (!partie) {
        alert("Erreur: Partie non trouvée pour modification.");
        console.error("Partie non trouvée avec l'ID:", partieId);
        return;
      }

      partieIdEditionInput.value = partie.id;
      editJeuInput.value = partie.nom_jeu;
      editDatePartieInput.value = formatDateToInput(partie.date); 
      
      // Clear and populate players
      editSelectedJoueursDiv.innerHTML = '';
      partie.joueurs.forEach(joueurNom => {
        const joueur = joueurs.find(j => j.nom === joueurNom);
        if (joueur) {
          addSelectedItem(joueur, editSelectedJoueursDiv, editJoueursInput);
        }
      });
      
      // Setup edit autocompletes
      setupAutocomplete(editJeuInput, editJeuSuggestions, jeux, (jeu) => {
        editJeuInput.value = jeu.nom;
      });
      setupAutocomplete(editJoueursInput, editJoueursSuggestions, joueurs, (joueur) => {
        const existingPlayers = getParticipants(editJoueursInput);
        if (!existingPlayers.includes(joueur.nom)) {
          addSelectedItem(joueur, editSelectedJoueursDiv, editJoueursInput);
        }
      });

      editVainqueurInput.value = partie.gagnant;
      updateVainqueursList(partie.joueurs);

      editionSection.style.display = 'block';
      editionSection.scrollIntoView({ behavior: 'smooth' });
    }

    formEdition.addEventListener('submit', async (e) => {
      e.preventDefault();
      const partieId = partieIdEditionInput.value;
      if (!partieId) {
          alert("Erreur: ID de partie manquant pour la modification.");
          return;
      }
      const nomJeu = editJeuInput.value;
      const datePartie = editDatePartieInput.value;
      const joueursSelectionnes = getParticipants(editJoueursInput);
      const vainqueur = editVainqueurInput.value;
      
      if (!nomJeu) {
          alert("Veuillez sélectionner un jeu.");
          return;
      }
      if (joueursSelectionnes.length === 0) {
          alert("Veuillez sélectionner au moins un joueur participant.");
          return;
      }
      if (!vainqueur || !joueursSelectionnes.includes(vainqueur)) {
        alert("Le vainqueur doit faire partie des joueurs sélectionnés.");
        return;
      }
      
      const partieModifiee = {
          date: new Date(datePartie).toISOString(),
          nom_jeu: nomJeu,
          joueurs: joueursSelectionnes,
          gagnant: vainqueur,
      };
      
      const result = await modifierPartie(partieId, partieModifiee);
      if (result.success) {
          alert("Partie modifiée !");
          editionSection.style.display = 'none';
          await chargerEtAfficherToutesLesDonnees();
      } else {
          alert("Erreur lors de la modification de la partie.");
          console.error("Erreur lors de la modification de la partie:", result.error);
      }
    });

    btnAnnulerEdition.addEventListener('click', () => {
      editionSection.style.display = 'none';
    });
    
    // --- Chargement initial et changements de visibilité ---
    document.addEventListener('DOMContentLoaded', async () => {
      await chargerEtAfficherToutesLesDonnees();
      const urlParams = new URLSearchParams(window.location.search);
      const jeuFiltre = urlParams.get('jeu');
      if (jeuFiltre) {
          filtreJeu.value = jeuFiltre;
          afficherParties();
      }
    });

    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        await chargerEtAfficherToutesLesDonnees();
      }
    });
  </script>
</body>
</html>