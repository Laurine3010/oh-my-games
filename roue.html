<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oh My Games - Roue des jeux</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Styles pour la roue - Simplification et correction */
    #roue-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 50px;
    }
    #roue-wrapper {
      position: relative;
      width: 400px; /* Taille de la roue */
      height: 400px;
      border-radius: 50%;
      border: 5px solid #333;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      overflow: hidden; /* Important pour cacher le d√©bordement des segments */
    }
    #roue {
      width: 100%;
      height: 100%;
      position: relative;
      /* La transition sera ajout√©e et retir√©e par JS */
    }
    .roue-segment {
      /* Le segment couvre tout le cercle au d√©part */
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      /* Masquage de la portion du cercle (tr√®s technique) */
      clip-path: polygon(50% 50%, 50% 0, 100% 0, 100% 100%, 0 100%, 0 0, 50% 0);
      transform-origin: 50% 50%; /* Rotation √† partir du centre */
    }

    /* Positionnement du texte */
    .roue-texte {
      position: absolute;
      /* Positionnement pour √™tre sur le rayon */
      top: 50%;
      left: 50%;
      width: 50%; /* La largeur est la moiti√© du rayon */
      text-align: center;
      /* D√©calage sur le rayon, rotation pour aligner, et rotation pour √™tre √† l'horizontal */
      transform: 
        rotate(var(--rotation-deg)) /* Rotation pour centrer sur le segment */
        translate(30%) /* D√©calage sur le rayon (ajustement visuel) */
        rotate(90deg); /* Texte √† la verticale */
      transform-origin: 0% 0%;
      padding: 5px;
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 2px #000;
      font-size: 0.8em;
      white-space: nowrap;
      overflow: hidden;
    }
    
    /* Le pointeur */
    #roue-pointeur {
      position: absolute;
      top: -25px; 
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 25px solid #d93d3d; /* Pointe rouge */
      z-index: 100;
    }
    
    #roue-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 30px;
        background-color: #333;
        border-radius: 50%;
        z-index: 101;
    }
    
    #resultat-roue {
      margin-top: 30px;
      font-size: 1.5em;
      font-weight: bold;
      min-height: 2em;
    }
    
    .filter-controls {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        text-align: center;
    }
    .filter-controls label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }
    .filter-controls select, .filter-controls input {
        width: 80%;
        padding: 8px;
        margin-top: 5px;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
  </style>
</head>
<body>

  <h1>Oh My Games</h1>
  <h2>Roue des jeux</h2>
  <div id="group-info" style="text-align: right; margin-top: -30px; margin-right: 10px;">
    <span id="current-group-alias"></span>
    <button onclick="location.href='groupes.html'" style="margin-left: 10px;">Changer de groupe</button>
  </div>
  <img src="omg_img.png" alt="Fond" class="background-image" />
  
  <main id="roue-container">
    
    <div class="filter-controls">
        <h3>Filtres de la roue</h3>
        <label for="nombre-joueurs">Nombre de joueurs actuels:</label>
        <input type="number" id="nombre-joueurs" min="1" max="10" value="4">
        <button id="btn-appliquer-filtres" style="margin-top: 15px;">Appliquer les filtres et recharger</button>
        <p id="info-jeux-dispo" style="margin-top: 10px;">Chargement...</p>
    </div>
    
    <div id="roue-wrapper">
      <div id="roue"></div>
      <div id="roue-pointeur"></div>
      <div id="roue-center"></div>
    </div>
    
    <div id="resultat-roue"></div>
    <button id="btn-spin" disabled>Faire tourner la roue !</button>
  </main>

  <button class="btn-home" onclick="location.href='home.html'">üè† Home</button>

  <script type="module">
    console.log("Script roue.html charg√©.");

    import { supabase } from './supabase-config.js';

    // --- Variables globales et DOM ---
    const roue = document.getElementById('roue');
    const btnSpin = document.getElementById('btn-spin');
    const resultatRoue = document.getElementById('resultat-roue');
    const inputNbJoueurs = document.getElementById('nombre-joueurs');
    const btnAppliquerFiltres = document.getElementById('btn-appliquer-filtres');
    const infoJeuxDispo = document.getElementById('info-jeux-dispo');
    
    let jeuxComplets = []; // Tous les jeux du groupe
    let jeuxFiltres = []; // Les jeux affich√©s dans la roue
    let selectedGroupId = null;

    // Couleurs plus contrast√©es pour la roue
    const couleurs = [
        '#FF5733', '#FFC300', '#33FF57', '#33C4FF', '#BB33FF', 
        '#FF33BB', '#00FFC3', '#C3FF00', '#3357FF', '#FF3333'
    ]; 
    // ---------------------------------------------

    // --- Initialisation du Groupe ---
    selectedGroupId = localStorage.getItem('selected_group_id');
    if (!selectedGroupId) {
        location.href = 'groupes.html';
        throw new Error("Groupe non s√©lectionn√©.");
    }
    const selectedGroupAlias = localStorage.getItem('selected_group_alias');
    document.getElementById('current-group-alias').textContent = `Groupe : ${selectedGroupAlias}`;
    // ---------------------------------

    // --- Fonctions de chargement et filtrage ---

    /**
     * Charge tous les jeux du groupe depuis Supabase.
     */
    async function chargerJeux() {
        try {
            const { data, error } = await supabase
                .from('jeux')
                .select('nom, min_joueurs, max_joueurs, prete')
                .eq('groupe_id', selectedGroupId)
                .eq('prete', false); // Exclure les jeux pr√™t√©s (logique standard)
            
            if (error) throw error;
            jeuxComplets = data;
            return data;
        } catch (error) {
            console.error("Erreur lors du chargement des jeux:", error);
            return [];
        }
    }
    
    /**
     * Applique les filtres (nombre de joueurs) aux jeux charg√©s.
     * @param {number} nbJoueurs - Nombre de joueurs actuel.
     */
    function appliquerFiltres(nbJoueurs) {
        if (!jeuxComplets || jeuxComplets.length === 0) {
            jeuxFiltres = [];
            return;
        }

        nbJoueurs = parseInt(nbJoueurs, 10);
        
        jeuxFiltres = jeuxComplets.filter(jeu => {
            const min = jeu.min_joueurs || 1;
            const max = jeu.max_joueurs || 99; // 99 pour les jeux sans max d√©fini
            
            return nbJoueurs >= min && nbJoueurs <= max;
        });
    }

    // --- Fonctions d'affichage de la roue ---

    function afficherRoulette(jeux) {
        roue.innerHTML = '';
        const nombreJeux = jeux.length;
        
        if (nombreJeux === 0) {
            infoJeuxDispo.textContent = `0 jeu disponible pour ${inputNbJoueurs.value} joueurs.`;
            btnSpin.disabled = true;
            resultatRoue.textContent = "Aucun jeu ne correspond aux filtres.";
            return;
        }
        
        infoJeuxDispo.textContent = `${nombreJeux} jeu${nombreJeux > 1 ? 'x' : ''} disponible${nombreJeux > 1 ? 's' : ''}.`;
        btnSpin.disabled = false;
        resultatRoue.textContent = "Pr√™t √† tourner !";

        // Calcul de l'angle pour chaque segment
        const angleParJeu = 360 / nombreJeux;
        let rotationCourante = 0;

        jeux.forEach((jeu, index) => {
            const segment = document.createElement('div');
            
            // Les segments sont des cercles masqu√©s puis tourn√©s et coup√©s
            segment.className = 'roue-segment';
            segment.style.backgroundColor = couleurs[index % couleurs.length];
            
            // Rotation pour positionner le segment
            segment.style.transform = `rotate(${rotationCourante}deg)`;

            // Masquer la partie du segment qui ne correspond pas √† l'angle
            // La technique de clip-path permet de visualiser le segment
            // Pour des segments de plus de 90 degr√©s, il faut superposer plusieurs triangles, mais pour simplifier, 
            // nous allons utiliser une simple rotation et une coupe visuelle.

            // Solution la plus simple (mais visuellement imparfaite pour les petits segments)
            // C'est la rotation du segment lui-m√™me qui cr√©e l'effet d'une part de tarte.
            
            // Rotation du texte pour le centrer dans le segment
            const textRotation = rotationCourante + (angleParJeu / 2);

            const texteDiv = document.createElement('div');
            texteDiv.className = 'roue-texte';
            texteDiv.textContent = jeu.nom;
            // Positionner le texte le long du rayon et le mettre √† l'horizontal
            texteDiv.style.setProperty('--rotation-deg', `${textRotation}deg`);
            
            segment.appendChild(texteDiv);
            roue.appendChild(segment);
            
            rotationCourante += angleParJeu;
        });
    }


    // --- Logique de la rotation ---

    btnSpin.addEventListener('click', () => {
        if (jeuxFiltres.length === 0) {
            resultatRoue.textContent = "Aucun jeu disponible ! Appliquez des filtres.";
            return;
        }

        btnSpin.disabled = true;
        resultatRoue.textContent = "La roue tourne...";
        roue.style.transition = "transform 5s cubic-bezier(0.2, 0.9, 0.4, 1)";
        
        const nombreJeux = jeuxFiltres.length;
        const angleParJeu = 360 / nombreJeux;

        // Choix de l'index gagnant (0 est le premier segment en partant du haut, sens horaire)
        const indexChoisi = Math.floor(Math.random() * nombreJeux);
        
        // D√©terminer la rotation n√©cessaire pour amener le segment choisi au niveau du pointeur (0¬∞)
        // L'angle de d√©but du segment choisi est (indexChoisi * angleParJeu)
        // Pour le centrer sur 0¬∞, il faut le faire tourner de 360 - (angle de d√©but + angleParJeu / 2)
        const angleTarget = 360 - (indexChoisi * angleParJeu + (angleParJeu / 2));

        // Ajouter des tours pour l'effet visuel
        const tours = 5;
        const deg = tours * 360 + angleTarget;
        
        roue.style.transform = `rotate(${deg}deg)`;

        roue.addEventListener('transitionend', function handler() {
            roue.style.transition = 'none';
            
            const jeuChoisi = jeuxFiltres[indexChoisi];
            
            // R√©ajuster la rotation pour que le segment choisi soit exactement centr√© (en retirant les tours)
            roue.style.transform = `rotate(${angleTarget}deg)`;
            
            resultatRoue.textContent = `F√©licitations, vous jouez √† "${jeuChoisi.nom}" ! üéâ`;
            btnSpin.disabled = false;
            
            roue.removeEventListener('transitionend', handler); // Nettoyage
        }, { once: true });
    });

    // --- Logique d'initialisation et des listeners ---

    btnAppliquerFiltres.addEventListener('click', () => {
        const nbJoueurs = inputNbJoueurs.value;
        if (nbJoueurs < 1) {
            alert("Le nombre de joueurs doit √™tre d'au moins 1.");
            return;
        }
        appliquerFiltres(nbJoueurs);
        afficherRoulette(jeuxFiltres);
    });

    async function initialiserRoue() {
        await chargerJeux();
        // Filtrer les jeux pour 4 joueurs par d√©faut au chargement
        appliquerFiltres(inputNbJoueurs.value); 
        afficherRoulette(jeuxFiltres);
    }

    document.addEventListener('DOMContentLoaded', initialiserRoue);

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            initialiserRoue();
        }
    });
  </script>
</body>
</html>